name: Build and Package

on:
    push:
      tags:
        - "v[0-100]+.[0-9]+.[0-1000]-stable"
    workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        python-version: [3.8.4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Python Embedded
        run: |
          Invoke-WebRequest -Uri https://www.python.org/ftp/python/${{ matrix.python-version }}/python-${{ matrix.python-version }}-embed-amd64.zip -OutFile python-embed.zip
          Expand-Archive python-embed.zip -DestinationPath python-embed

      - name: Set up Python Embedded
        run: |
          $env:Path += ";$PWD/python-embed"
          python -m ensurepip
          python -m pip install --upgrade pip

      - name: Install dependencies
        run: python -m pip install -r requirements.txt

      - name: Insert build info
        run: |
          $buildInfo = 'BUILD_INFO="Build in ${{github.run_id}}(${{github.sha}})"'
          $versionInfo = 'VERSION="${{github.ref_name}}"'
          $buildInfo | Out-File -FilePath src/buildinfo.py -Encoding utf8
          $versionInfo | Out-File -FilePath src/buildinfo.py -Encoding utf8 -Append
        shell: pwsh

      - name: Compile Python files to .pyc
        run: python -m compileall src

      - name: Remove .py files
        run: Remove-Item -Recurse -Force src\*.py
        shell: pwsh

      - name: Create start.bat
        run: |
          echo @echo off > start.bat
          echo python-embed\python.exe -m src.main >> start.bat
      
      - name: Package application
        run: |
          mkdir dist
          Copy-Item -Recurse -Force python-embed dist/python-embed
          Copy-Item -Recurse -Force src dist/src
          Copy-Item -Force start.bat dist/start.bat
        shell: pwsh

      - name: Compress package
        run: Compress-Archive -Path dist -DestinationPath idv-login-${{github.ref_name}}-Py${{ matrix.python-version }}.zip
        shell: pwsh

      - name: Calculate Client checksum
        run: Get-FileHash "idv-login-${{github.ref_name}}-Py${{ matrix.python-version }}.zip" | select-object -ExpandProperty Hash > idv-login-${{github.ref_name}}-Py${{ matrix.python-version }}.zip.sha256

      - name: Archive production artifacts
        uses: actions/upload-artifact@v2
        with:
          name: production-artifacts
          path: |
            idv-login-${{github.ref_name}}-Py${{ matrix.python-version }}.zip
            idv-login-${{github.ref_name}}-Py${{ matrix.python-version }}.zip.sha256