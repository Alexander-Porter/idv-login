name: Sync Release

on:
  release:
    types:
      - published
  workflow_dispatch:

jobs:
  sync_release:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest release
        id: latest_release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            console.log(release.data);
            return release.data;

      - name: Create release on Gitee
        env:
          release_data: ${{ fromJSON(steps.latest_release.outputs.result)}}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_ROPE: ${{ secrets.GITEE_ROPE }}
        run: |
          echo ${{ env.release_data.tag_name }}
          curl -X POST "https://gitee.com/api/v5/repos/${{secrets.GITEE_ROPE}}/releases" \
          -H "Content-Type: application/json;charset=UTF-8" \
          -d '{
            "access_token": "${{ secrets.GITEE_TOKEN }}",
            "tag_name": "${{ env.release_data.tag_name }}",
            "name": "${{ env.release_data.name }}",
            "body": "${{ env.release_data.body }}",
            "target_commitish": ${{env.release_data.target_commitish}},
          }'