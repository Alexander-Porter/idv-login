<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æ¸ é“æœè´¦å·ç®¡ç†</title>
    <link rel="icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+P+/HgAFdwI2QOQjeQAAAABJRU5ErkJggg==">


    <!-- èµ„æºä¼˜å…ˆä» s4.zstatic.net åŠ è½½ï¼Œå¤±è´¥å›é€€åˆ° cloudflare -->
    <script>
        (function () {
            const primary = {
                js: [
                    { src: 'https://s4.zstatic.net/ajax/libs/sweetalert/2.1.2/sweetalert.min.js', integrity: 'sha512-AA1Bzp5Q0K1KanKKmvN/4d3IRKVlv9PYgwFPvm32nPO6QS8yH1HO7LbgB1pgiOxPtfeg5zEn2ba64MUcqJx6CA==' },
                    { src: 'https://s4.zstatic.net/ajax/libs/bootstrap/5.3.8/js/bootstrap.min.js', integrity: 'sha512-nKXmKvJyiGQy343jatQlzDprflyB5c+tKCzGP3Uq67v+lmzfnZUi/ZT+fc6ITZfSC5HhaBKUIvr/nTLCV+7F+Q==' }
                ],
                css: [
                    { href: 'https://s4.zstatic.net/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css', integrity: 'sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA==' },
                    { href: 'https://s4.zstatic.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css', integrity: 'sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==' }
                ]
            };

            const fallback = {
                js: [
                    { src: 'https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js', integrity: 'sha512-AA1Bzp5Q0K1KanKKmvN/4d3IRKVlv9PYgwFPvm32nPO6QS8yH1HO7LbgB1pgiOxPtfeg5zEn2ba64MUcqJx6CA==' },
                    { src: 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.min.js', integrity: 'sha512-nKXmKvJyiGQy343jatQlzDprflyB5c+tKCzGP3Uq67v+lmzfnZUi/ZT+fc6ITZfSC5HhaBKUIvr/nTLCV+7F+Q==' }
                ],
                css: [
                    { href: 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css', integrity: 'sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA==' },
                    { href: 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css', integrity: 'sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==' }
                ]
            };

            function loadCssItem(item) {
                return new Promise((resolve) => {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = item.href;
                    if (item.integrity) link.integrity = item.integrity;
                    link.crossOrigin = 'anonymous';
                    link.referrerPolicy = 'no-referrer';
                    link.onload = () => resolve({ ok: true });
                    link.onerror = () => resolve({ ok: false });
                    document.head.appendChild(link);
                });
            }

            function loadScriptItem(item, isModule) {
                return new Promise((resolve) => {
                    const s = document.createElement('script');
                    s.src = item.src;
                    if (item.integrity) s.integrity = item.integrity;
                    s.crossOrigin = 'anonymous';
                    s.referrerPolicy = 'no-referrer';
                    // ä¿è¯æŒ‰é¡ºåºæ‰§è¡Œ
                    s.async = false;
                    s.onload = () => resolve({ ok: true });
                    s.onerror = () => resolve({ ok: false });
                    document.head.appendChild(s);
                });
            }

            async function tryLoadWithFallback(primaryList, fallbackList, loader) {
                const results = [];
                for (let i = 0; i < primaryList.length; i++) {
                    const p = primaryList[i];
                    const f = fallbackList && fallbackList[i] ? fallbackList[i] : null;
                    const res = await loader(p);
                    if (res.ok) {
                        results.push(true);
                    } else if (f) {
                        const r2 = await loader(f);
                        results.push(r2.ok);
                    } else {
                        results.push(false);
                    }
                }
                return results;
            }

            // å¯åŠ¨åŠ è½½ï¼šå…ˆ css å¹¶è¡ŒåŠ è½½ï¼Œè„šæœ¬æŒ‰é¡ºåºåŠ è½½
            (async function () {
                // CSS: æˆ‘ä»¬å¸Œæœ›å…ˆåŠ è½½ bootstrap CSS ç„¶å iconsï¼Œä½†ä¸¤ä¸ªå¯ä»¥å¹¶è¡Œ
                // ä¸ºæ¯ä¸ª CSS èµ„æºåˆ›å»ºä¸€ä¸ª promiseï¼Œå¤±è´¥æ—¶å›é€€åˆ°å¤‡ç”¨ CDN
                await Promise.all(primary.css.map((p, idx) => {
                    const f = (fallback.css && fallback.css[idx]) ? fallback.css[idx] : null;
                    return loadCssItem(p).then(res => res.ok ? true : (f ? loadCssItem(f).then(r => r.ok) : false));
                }));

                // JS: éœ€è¦æŒ‰é¡ºåºåŠ è½½ sweetalert -> bootstrap
                await tryLoadWithFallback(primary.js, fallback.js, loadScriptItem);
            })();
        })();
    </script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .page-header {
            background-color: #3f6ad8;
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card-header {
            font-weight: 500;
            background-color: rgba(0, 0, 0, 0.02);
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        }

        .table {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 4px;
            margin-right: 3px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #495057;
            margin-bottom: 1rem;
            border-left: 3px solid #3f6ad8;
            padding-left: 0.75rem;
        }

        .form-control,
        .form-select {
            border-radius: 0.375rem;
        }

        .btn-group {
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .action-label {
            font-size: 0.75rem;
            display: block;
            text-align: center;
            margin-top: 2px;
            color: #6c757d;
        }

        .actions-container {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .table th {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .launcher-card-body {
            position: relative;
            overflow: hidden;
        }

        .launcher-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: blur(16px);
            opacity: 0.35;
            transform: scale(1.1);
        }

        .launcher-content {
            position: relative;
            z-index: 1;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .status-light.connected {
            background-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        }

        .status-light.disconnected {
            background-color: #dc3545;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
            animation: pulse 2s infinite;
        }

        .status-light.warning {
            background-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.6);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-text {
            font-size: 0.875rem;
            color: #495057;
            margin: 0;
        }

        .status-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* æ–­å¼€è¿æ¥æ—¶çš„é¢å¤–æç¤ºæ ·å¼ */
        .status-indicator.disconnected-state {
            background: rgba(220, 53, 69, 0.95);
            color: white;
            animation: shake 0.5s ease-in-out;
            animation-delay: 1s;
        }

        .status-indicator.disconnected-state .status-text {
            color: white;
            font-weight: 500;
        }

        .status-indicator.disconnected-state::after {
            content: 'ğŸ‘† ç‚¹å‡»æŸ¥çœ‹è§£å†³æ–¹æ¡ˆ';
            position: absolute;
            bottom: -30px;
            right: 0;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            animation: bounce 2s infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* å…¨å±€é®ç½©å±‚ï¼ˆå¯é€‰ï¼Œåœ¨è¿æ¥å¤±è´¥æ—¶é—´è¿‡é•¿æ—¶æ˜¾ç¤ºï¼‰ */
        .connection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .connection-overlay.show {
            display: flex;
        }

        .connection-modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .connection-modal h3 {
            color: #dc3545;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .connection-modal p {
            color: #495057;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .connection-modal .btn-primary {
            background: #dc3545;
            border: none;
            padding: 10px 30px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .connection-modal .btn-primary:hover {
            background: #c82333;
        }

        #launcherIcon {
            width: 96px;
            height: 96px;
            object-fit: contain;
            border-radius: 12px;
            background: #f0f0f0;
        }

        #launcherIcon.hidden {
            display: none;
        }

        /* å¢å¼ºçš„ç¦ç”¨æŒ‰é’®æ ·å¼ */
        .btn:disabled,
        .btn.disabled {
            cursor: not-allowed !important;
            opacity: 0.6 !important;
            background-color: #e9ecef !important;
            border-color: #dee2e6 !important;
            color: #adb5bd !important;
            box-shadow: none !important;
            pointer-events: auto !important; /* å…è®¸æ˜¾ç¤ºé¼ æ ‡æ ·å¼ */
        }

        /* ä¸ºä¸‹è½½å’Œæ›´æ–°æŒ‰é’®æ·»åŠ ç‰¹å®šæç¤º */
        #launcherInstallBtn:disabled::after,
        #launcherUpdateBtn:disabled::after {
            content: ' (ä¸å¯ç”¨)';
            font-size: 0.8em;
            margin-left: 4px;
        }
    </style>
</head>

<body>
    <!-- è¿æ¥å¤±è´¥å…¨å±€é®ç½©å±‚ -->
    <div class="connection-overlay" id="connectionOverlay">
        <div class="connection-modal">
            <h3>âš ï¸ å·¥å…·æœªè¿æ¥</h3>
            <p>æ£€æµ‹åˆ°å·¥å…·åç«¯æœåŠ¡æœªè¿è¡Œæˆ–è¿æ¥å¤±è´¥ã€‚<br>è¯·æ£€æŸ¥å·¥å…·æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œæˆ–æŸ¥çœ‹å¸¸è§é—®é¢˜è§£ç­”è·å–å¸®åŠ©ã€‚</p>
            <button class="btn btn-primary" onclick="openFAQAndCloseOverlay()">
                <i class="bi bi-question-circle me-2"></i>æŸ¥çœ‹å¸¸è§é—®é¢˜è§£ç­”
            </button>
            <p class="mt-3 small text-muted">
                <a href="#" onclick="dismissOverlay(); return false;" style="color: #6c757d;">æˆ‘çŸ¥é“äº†ï¼Œæš‚æ—¶å¿½ç•¥</a>
            </p>
        </div>
    </div>

    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator" id="statusIndicator">
        <div class="status-light disconnected" id="statusLight"></div>
        <p class="status-text" id="statusText">æ£€æŸ¥ä¸­...</p>
    </div>

    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header text-center">
        <div class="container">
            <h1 class="fw-bold fs-3">æ¸ é“æœè´¦å·ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="lead fs-6 mb-0">è½»æ¾ç®¡ç†æ‚¨çš„æ¸¸æˆè´¦å·å’Œç™»å½•ä¿¡æ¯</p>
            <p class="small" >
                <a style="color: bisque;" href="https://docs.qq.com/form/page/DTk1LY0ZuZ1h5TmpZ" target="_blank"
                    class="text-decoration-none">ğŸ–Šç‚¹æ­¤å‚ä¸æ–°ç‰ˆæœ¬åŠŸèƒ½æŠ•ç¥¨</a>
            </p>
        </div>
    </div>

    <div class="container">
        <!-- å·¥å…·è®¾ç½®åŒºåŸŸ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-gear me-2"></i>å·¥å…·è®¾ç½®</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong>å¼€å¯HTTPDNSå±è”½</strong>
                                <small class="d-block text-muted">å±è”½HTTPDNSæœåŠ¡ä»¥ç¡®ä¿æ‹¦æˆªç”Ÿæ•ˆï¼Œä½†æ˜¯å¯èƒ½å¯¼è‡´éƒ¨åˆ†æ¸¸æˆè”ç½‘å¤±è´¥</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="httpdnsToggle"
                                    onchange="toggleHttpDnsBlocking()">
                                <label class="form-check-label" for="httpdnsToggle"></label>
                            </div>
                        </div>
                        <div id="httpdnsStatus" class="mt-2">
                            <small class="text-muted">çŠ¶æ€ï¼š<span id="httpdnsStatusText">åŠ è½½ä¸­...</span></small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong>æ—¥å¿—å¯¼å‡º</strong>
                                <small class="d-block text-muted">å¯¼å‡ºåŒ…å«ç³»ç»Ÿä¿¡æ¯çš„å®Œæ•´è°ƒè¯•æ—¥å¿—</small>
                            </div>
                            <button onclick="exportLogs()" class="btn btn-outline-info">
                                <i class="bi bi-download me-1"></i>å¯¼å‡ºæ—¥å¿—
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- æ¸¸æˆé€‰æ‹©åŒºåŸŸ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-controller me-2"></i>æ¸¸æˆé€‰æ‹©</span>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label for="gameSelect" class="form-label fw-bold">å½“å‰æ¸¸æˆ:</label>
                        <select id="gameSelect" class="form-select" onchange="switchGame(this.value)">
                            <option value="" disabled selected>åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-rocket-takeoff me-2"></i>æ¸¸æˆå¯åŠ¨å™¨</span>
            </div>
            <div class="card-body launcher-card-body">
                <div id="launcherMainImage" class="launcher-bg"></div>
                <div class="row g-3 align-items-center launcher-content">
                    <div class="col-md-3 text-center">
                        <img id="launcherIcon" class="hidden" alt="launcher icon">
                    </div>
                    <div class="col-md-9">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <div>
                                <h5 class="mb-1" id="launcherTitle">åŠ è½½ä¸­...</h5>
                                <div class="text-muted small" id="launcherSubTitle">å¯åŠ¨å™¨ä¿¡æ¯</div>
                            </div>
                            <div class="text-muted small" id="launcherInstallPath">æœªå®‰è£…</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <small>å¼€å‘å•†ï¼š<span id="launcherDeveloper">-</span></small>
                            </div>
                            <div class="col-md-6">
                                <small>å‘è¡Œå•†ï¼š<span id="launcherPublisher">-</span></small>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <small>æœ¬åœ°ç‰ˆæœ¬ï¼š<span id="launcherLocalVersion">-</span></small>
                            </div>
                            <div class="col-md-4">
                                <small>ç›®æ ‡ç‰ˆæœ¬ï¼š<span id="launcherTargetVersion">-</span></small>
                            </div>
                            <div class="col-md-4">
                                <small>å¯åŠ¨æ–‡ä»¶ï¼š<span id="launcherStartupPath">-</span></small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="launcherDistributionSelect" class="form-label fw-bold">ç‰ˆæœ¬é€‰æ‹©:</label>
                            <select id="launcherDistributionSelect" class="form-select" onchange="updateLauncherDisplay()">
                                <option value="" disabled selected>åŠ è½½ä¸­...</option>
                            </select>
                        </div>
                        <div id="launcherStatusBadges" class="d-flex flex-wrap gap-2 mt-3"></div>
                        <div class="btn-group w-100 mt-3">
                            <button id="launcherInstallBtn" onclick="installLauncher()" class="btn btn-outline-success">
                                <i class="bi bi-download me-1"></i>æ—§åŒ…ä½“å‡çº§åˆ°æ–°å¼•æ“æˆ–ä»æœªå®‰è£…
                            </button>
                            <button id="launcherUpdateBtn" onclick="updateLauncher()" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-repeat me-1"></i>æ–°å¼•æ“æ£€æŸ¥æ›´æ–°
                            </button>
                            <button id="launcherImportFeverListBtn" onclick="importFeverLauncherList()" class="btn btn-outline-secondary">
                                <i class="bi bi-box-arrow-in-down me-1"></i>å¯¼å…¥å‘çƒ§å¹³å°å·²æœ‰æ¸¸æˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <div class="row">
        <!-- ç™»å½•æ“ä½œ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-box-arrow-in-right me-2"></i>è´¦å·ç™»å½•</span>
                </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="channelSelect" class="form-label">æ¸ é“é€‰æ‹©:</label>
                            <div class="d-flex align-items-center">
                                <select id="channelSelect" class="form-select me-2"
                                    style="width: 80%; flex: 0 0 auto;"></select>
                                <button onclick="manual()" class="btn btn-primary">
                                    <i class="bi bi-person-plus me-1"></i>æ‰‹åŠ¨ç™»å½•
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <p class="mb-1">å½“å‰è‡ªåŠ¨ç™»å½•è´¦å·ï¼š</p>
                            <div class="d-flex align-items-center">
                                <strong id="default" class="badge bg-info text-white p-2">Empty</strong>
                                <button onclick="clearDefault()" class="btn btn-outline-secondary ms-2 btn-sm">
                                    <i class="bi bi-x-circle me-1"></i>æ¸…é™¤è‡ªåŠ¨ç™»å½•
                                </button>
                            </div>
                        </div>
                        <!-- æ·»åŠ ç™»å½•å»¶è¿Ÿè®¾ç½® -->
                        <div class="mt-3">
                            <h5 class="section-title">è‡ªåŠ¨ç™»å½•å»¶è¿Ÿè®¾ç½®</h5>
                            <div class="d-flex align-items-center">
                                <input type="number" id="loginDelayInput" style="width: 80%; flex: 0 0 auto;"
                                    class="form-control me-2" min="0" max="30" placeholder="å»¶è¿Ÿç§’æ•°">
                                <button onclick="saveLoginDelay()" class="btn btn-outline-primary">
                                    <i class="bi bi-save me-1"></i>ä¿å­˜
                                </button>
                            </div>
                            <small class="form-text text-muted mt-1">äºŒç»´ç æ˜¾ç¤ºå<span id="currentDelay">åŠ è½½ä¸­...</span>
                                ç§’ä¼šè‡ªåŠ¨ç™»å½•é»˜è®¤è´¦å·ã€‚</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-gear me-2"></i>è‡ªåŠ¨å¯åŠ¨/å…³é—­è®¾ç½®</span>
                    </div>
                    <div class="card-body">
                        <button id="autoCloseBtn" onclick="switchAutoClose()"
                            class="btn btn-outline-primary mb-3 w-100">
                            <i class="bi bi-power me-1"></i>ç™»å½•åè‡ªåŠ¨å…³é—­å·¥å…·ï¼šåŠ è½½ä¸­...
                        </button>

                        <div class="mt-3">
                            <h5 class="section-title">æ¸¸æˆè‡ªåŠ¨å¯åŠ¨è®¾ç½®</h5>
                            <div class="d-flex align-items-center mb-2">
                                <span>çŠ¶æ€ï¼š</span>
                                <span class="ms-2 badge" id="autoStartStatus">åŠ è½½ä¸­...</span>
                                <span class="ms-3">è·¯å¾„ï¼š</span>
                                <small id="autoStartPath" class="text-muted ms-2 text-truncate">æœªè®¾ç½®</small>
                            </div>
                            <div class="btn-group w-100">
                                <button id="setAutoStartBtn" onclick="setAutoStart(true)"
                                    class="btn btn-outline-success">
                                    <i class="bi bi-plus-circle me-1"></i>è®¾ç½®æ¸¸æˆè·¯å¾„
                                </button>
                                <button id="disableAutoStartBtn" onclick="setAutoStart(false)"
                                    class="btn btn-outline-danger">
                                    <i class="bi bi-dash-circle me-1"></i>ç¦ç”¨è‡ªå¯
                                </button>
                                <button id="startGameBtn" onclick="startGame()" class="btn btn-primary">
                                    <i class="bi bi-play-fill me-1"></i>ç«‹å³å¯åŠ¨æ¸¸æˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4" id="cloudSyncCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-cloud-arrow-up me-2"></i>æ¸ é“æœè´¦å·äº‘åŒæ­¥</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" id="cloudSyncToggleBtn" onclick="toggleCloudSyncPanel()">
                        <i class="bi bi-chevron-right me-1"></i>å±•å¼€
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="showCloudSyncWizard()">
                        <i class="bi bi-magic me-1"></i>é…ç½®å‘å¯¼
                    </button>
                </div>
            </div>
            <div class="card-body" id="cloudSyncCardBody" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">ä¸»å¯†é’¥</label>
                        <input id="cloudSyncMasterKey" type="password" class="form-control" placeholder="å»ºè®®16ä½ä»¥ä¸Šï¼ŒåŒ…å«å¤§å°å†™/æ•°å­—/ç¬¦å·">
                        <small id="cloudSyncKeyStrength" class="text-muted">å¼ºåº¦ï¼šæœªæ£€æµ‹</small>
                    </div>

                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-3">
                        <label class="form-label">è®°ä½å¯†ç çº§åˆ«</label>
                        <select id="cloudSyncRememberLevel" class="form-select">
                            <option value="none">ä¸è®°ä½ä¸»å¯†é’¥</option>
                            <option value="master_key">è®°ä½ä¸»å¯†é’¥</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">åŒæ­¥æ–¹å‘</label>
                        <select id="cloudSyncDirection" class="form-select">
                            <option value="push">å•å‘ä¸Šä¼ ï¼ˆæœ¬åœ°â†’äº‘ç«¯ï¼‰</option>
                            <option value="pull">å•å‘ä¸‹è½½ï¼ˆäº‘ç«¯â†’æœ¬åœ°ï¼‰</option>
                            <option value="bidirectional">åŒå‘åŒæ­¥</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">è´¦å·èŒƒå›´</label>
                        <select id="cloudSyncScopeType" class="form-select">
                            <option value="all">å…¨éƒ¨è´¦å·</option>
                            <option value="current_game">å½“å‰æ¸¸æˆ</option>
                            <option value="selected">ä»…å‹¾é€‰è´¦å·</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">äº‘ç«¯è¿‡æœŸæ—¶é—´</label>
                        <select id="cloudSyncExpireAt" class="form-select">
                            <option value="3600">1å°æ—¶</option>
                            <option value="21600">6å°æ—¶</option>
                            <option value="86400">1å¤©</option>
                            <option value="259200" selected>3å¤© (é»˜è®¤)</option>
                            <option value="604800">1å‘¨</option>
                            <option value="2592000">1ä¸ªæœˆ</option>
                            <option value="7776000">3ä¸ªæœˆ</option>
                            <option value="15552000">åŠå¹´</option>
                            <option value="31536000">1å¹´</option>
                            <option value="63072000">2å¹´</option>
                            <option value="94608000">3å¹´</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="small text-muted" id="cloudSyncPolicyStateText">
                        è®¸å¯çŠ¶æ€ï¼šæœªåŒæ„ï¼ˆè¯·å…ˆå®Œæˆé…ç½®å‘å¯¼ç¬¬ä¸€æ­¥ï¼‰
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="cloudSyncAutoSync">
                        <label class="form-check-label" for="cloudSyncAutoSync">è‡ªåŠ¨åŒæ­¥</label>
                    </div>
                </div>
                <div class="btn-group w-100 mt-3">
                    <button class="btn btn-outline-primary" onclick="saveCloudSyncSettings()"><i class="bi bi-save me-1"></i>ä¿å­˜åŒæ­¥è®¾ç½®</button>
                    <button class="btn btn-outline-success" onclick="runCloudSync('push')"><i class="bi bi-upload me-1"></i>æ‰‹åŠ¨ä¸Šä¼ </button>
                    <button class="btn btn-outline-info" onclick="runCloudSync('pull')"><i class="bi bi-download me-1"></i>æ‰‹åŠ¨ä¸‹è½½</button>
                    <button class="btn btn-outline-secondary" onclick="runCloudSync('sync')"><i class="bi bi-arrow-left-right me-1"></i>æŒ‰æ–¹å‘æ‰§è¡ŒåŒæ­¥</button>
                </div>
                <div class="btn-group w-100 mt-2">
                    <button class="btn btn-outline-dark" onclick="viewCloudSyncLogs()"><i class="bi bi-clock-history me-1"></i>è®¿é—®æ—¥å¿—</button>
                    <button class="btn btn-outline-danger" onclick="deleteCloudSync()"><i class="bi bi-trash me-1"></i>åˆ é™¤äº‘ç«¯åŒæ­¥</button>
                </div>
            </div>
        </div>

        <!-- è´¦å·åˆ—è¡¨ -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-ul me-2"></i>è´¦å·åˆ—è¡¨</span>
                <div class="btn-group" id="batchOperationsGroup">
                    <button onclick="batchDelete()" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash me-1"></i>æ‰¹é‡åˆ é™¤
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" width="5%"><input type="checkbox" id="selectAll"></th>
                                <th scope="col" width="20%">UUID</th>
                                <th scope="col" width="20%">åç§°</th>
                                <th scope="col" width="25%">ä¸Šæ¬¡ç™»å½•</th>
                                <th scope="col" width="30%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="channelTableBody">
                            <!-- è´¦å·è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </tbody>
                    </table>
                </div>
                <div id="noAccounts" class="alert alert-secondary text-center" style="display:none;">
                    <i class="bi bi-info-circle me-2"></i> æš‚æ— è´¦å·è®°å½•ï¼Œè¯·é€šè¿‡æ‰‹åŠ¨ç™»å½•æˆ–ç”¨æ¸¸æˆå®¢æˆ·ç«¯æ‰«ç æ·»åŠ è´¦å·
                </div>
            </div>
        </div>

        <footer class="mt-4 text-center text-muted">
            <p class="small">IDV-LOGINæ¸ é“æœè´¦å·ç®¡ç†ç•Œé¢ &copy; 2025</p>
            <p class="small">
                <a href="https://www.yuque.com/keygen/kg2r5k/izpgpf4g3ecqsbf3" target="_blank"
                    class="text-decoration-none">å®˜æ–¹æ•™ç¨‹</a>
            </p>
            <p class="small">
                <a href="https://www.yuque.com/keygen/kg2r5k/xl9zosrwviyc54nu" target="_blank"
                    class="text-decoration-none">å‡ºç°é—®é¢˜ï¼Ÿ</a>
            </p>

        </footer>
    </div>


    <script>
        function cmpGameId(game_id_a, game_id_b) {
            if (game_id_a === "" || game_id_b === "") {
                return game_id_a === game_id_b;
            }
            const short_a = game_id_a.split("-").pop();
            const short_b = game_id_b.split("-").pop();
            return short_a === short_b;
        }

        function timeStampToLocalTime(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        };
        function renameChannel(uuid) {
            var newName = prompt("è¯·è¾“å…¥æ–°çš„è´¦å·åç§°");
            if (newName) {
                fetch(`/_idv-login/rename?uuid=${uuid}&new_name=${newName}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            swal('è´¦å·å·²æˆåŠŸæ”¹å');
                            location.reload();
                        } else {
                            swal('æ”¹åå¤±è´¥');
                        }
                    });
            }
        }

        function deleteChannel(uuid) {
            swal({
                title: "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ",
                text: "åˆ é™¤åå°†æ— æ³•æ¢å¤æ­¤è´¦å·ä¿¡æ¯",
                icon: "warning",
                buttons: ["å–æ¶ˆ", "ç¡®å®šåˆ é™¤"],
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        fetch(`/_idv-login/del?uuid=${uuid}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    swal('è´¦å·å·²æˆåŠŸåˆ é™¤', {
                                        icon: "success",
                                    });
                                    location.reload();
                                } else {
                                    swal('åˆ é™¤å¤±è´¥', {
                                        icon: "error",
                                    });
                                }
                            });
                    }
                });
        }

        function batchDelete() {
            // è·å–æ‰€æœ‰é€‰ä¸­çš„è´¦å·
            const selectedAccounts = [];
            document.querySelectorAll('.account-checkbox:checked').forEach(checkbox => {
                selectedAccounts.push(checkbox.value);
            });

            if (selectedAccounts.length === 0) {
                swal({
                    title: "æœªé€‰æ‹©è´¦å·",
                    text: "è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è´¦å·",
                    icon: "warning",
                    button: "ç¡®å®š",
                });
                return;
            }

            swal({
                title: "æ‰¹é‡åˆ é™¤ç¡®è®¤",
                text: `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedAccounts.length} ä¸ªè´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
                icon: "warning",
                buttons: ["å–æ¶ˆ", "ç¡®å®šåˆ é™¤"],
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
                        swal({
                            title: "åˆ é™¤ä¸­...",
                            text: "æ­£åœ¨æ‰¹é‡åˆ é™¤è´¦å·",
                            icon: "info",
                            buttons: false,
                            closeOnClickOutside: false,
                        });

                        // åˆ›å»ºä¸€ä¸ªPromiseæ•°ç»„æ¥è·Ÿè¸ªæ‰€æœ‰åˆ é™¤è¯·æ±‚
                        const deletePromises = selectedAccounts.map(uuid => {
                            return fetch(`/_idv-login/del?uuid=${uuid}`)
                                .then(response => response.json())
                                .then(data => ({ uuid, success: data.success }));
                        });

                        // ç­‰å¾…æ‰€æœ‰åˆ é™¤è¯·æ±‚å®Œæˆ
                        Promise.all(deletePromises)
                            .then(results => {
                                const successful = results.filter(r => r.success).length;
                                const failed = results.length - successful;

                                swal({
                                    title: "æ‰¹é‡åˆ é™¤å®Œæˆ",
                                    text: `æˆåŠŸåˆ é™¤ ${successful} ä¸ªè´¦å·${failed > 0 ? `ï¼Œ${failed} ä¸ªè´¦å·åˆ é™¤å¤±è´¥` : ''}`,
                                    icon: successful > 0 ? "success" : "warning",
                                    button: "ç¡®å®š",
                                }).then(() => {
                                    location.reload();
                                });
                            });
                    }
                });
        }

        function switchChannel(uuid) {
            game_id = getQueryVariable("game_id");
            fetch(`/_idv-login/switch?uuid=${uuid}&game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.current == uuid) {
                        swal({
                            title: "æ¨¡æ‹Ÿç™»å½•æˆåŠŸ",
                            icon: "success",
                            button: "ç¡®å®š",
                        });
                        location.reload();
                    } else {
                        swal({
                            title: "ç™»å½•å¤±è´¥",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                });
        }
        function defaultChannel(uuid) {
            game_id = getQueryVariable("game_id");
            fetch(`/_idv-login/setDefault?uuid=${uuid}&game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        swal({
                            title: "è®¾ç½®é»˜è®¤è´¦å·æˆåŠŸ",
                            icon: "success",
                            button: "ç¡®å®š",
                        });
                        location.reload();
                    } else {
                        swal({
                            title: "è®¾ç½®å¤±è´¥",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                });
        }

        function clearDefault() {
            game_id = getQueryVariable("game_id");
            fetch(`/_idv-login/clearDefault?game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        swal({
                            title: "æ¸…é™¤é»˜è®¤è´¦å·æˆåŠŸ",
                            icon: "success",
                            button: "ç¡®å®š",
                        });
                        location.reload();
                    } else {
                        swal({
                            title: "æ¸…é™¤å¤±è´¥",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                });
        }

        // ç™»å½•å»¶è¿Ÿç›¸å…³å‡½æ•°
        function loadLoginDelay() {
            const game_id = getQueryVariable("game_id");
            if (!game_id) return;

            fetch(`/_idv-login/get-login-delay?game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('currentDelay').textContent = data.delay;
                    document.getElementById('loginDelayInput').value = data.delay;
                })
                .catch(err => {
                    console.error('è·å–ç™»å½•å»¶è¿Ÿå¤±è´¥:', err);
                    document.getElementById('currentDelay').textContent = 'è·å–å¤±è´¥';
                });
        }

        function saveLoginDelay() {
            const game_id = getQueryVariable("game_id");
            const delay = document.getElementById('loginDelayInput').value;

            if (!game_id) {
                swal({
                    title: "é”™è¯¯",
                    text: "æœªæ‰¾åˆ°æ¸¸æˆID",
                    icon: "error",
                    button: "ç¡®å®š",
                });
                return;
            }

            if (delay === "" || isNaN(delay) || delay < 0) {
                swal({
                    title: "è¾“å…¥é”™è¯¯",
                    text: "è¯·è¾“å…¥æœ‰æ•ˆçš„å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰",
                    icon: "warning",
                    button: "ç¡®å®š",
                });
                return;
            }

            fetch(`/_idv-login/set-login-delay?game_id=${game_id}&delay=${delay}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        swal({
                            title: "è®¾ç½®æˆåŠŸ",
                            text: `ç™»å½•å»¶è¿Ÿå·²è®¾ç½®ä¸º ${delay} ç§’`,
                            icon: "success",
                            button: "ç¡®å®š",
                        });
                        document.getElementById('currentDelay').textContent = delay;
                    } else {
                        swal({
                            title: "è®¾ç½®å¤±è´¥",
                            text: data.error || "æœªçŸ¥é”™è¯¯",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                })
                .catch(err => {
                    swal({
                        title: "è¯·æ±‚å¤±è´¥",
                        text: "ä¿å­˜å»¶è¿Ÿè®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯",
                        icon: "error",
                        button: "ç¡®å®š",
                    });
                });
        }

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return ("");
        }

        // æ¸¸æˆåˆ‡æ¢å‡½æ•°
        function switchGame(gameId) {
            if (gameId) {
                // æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
                swal({
                    title: "åˆ‡æ¢æ¸¸æˆä¸­...",
                    text: "æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®",
                    icon: "info",
                    buttons: false,
                    closeOnClickOutside: false,
                });

                // é‡å®šå‘åˆ°ç›¸åŒçš„URLï¼Œä½†æ”¹å˜game_idæŸ¥è¯¢å‚æ•°
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('game_id', gameId);
                window.location.href = currentUrl.toString();
            }
        }

        // åŠ è½½æ¸¸æˆåˆ—è¡¨
        function loadGameList() {
            fetch('/_idv-login/list-games')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const gameSelect = document.getElementById('gameSelect');
                        // æ¸…ç©ºç°æœ‰é€‰é¡¹
                        gameSelect.innerHTML = '';

                        // è·å–å½“å‰é€‰ä¸­çš„æ¸¸æˆID
                        const currentGameId = getQueryVariable("game_id");
                        //å¦‚æœå½“å‰é€‰ä¸­idä¸ºç©ºï¼Œè¿œç«¯è¿”å›çš„æ¸¸æˆåˆ—è¡¨ä¹Ÿä¸ºç©ºï¼Œåˆ™é€šè¿‡localstorage ä¸€æ¬¡æ€§åœ°ç”¨swalè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦è·³è½¬åˆ°https://localhost/_idv-login/index?game_id=aecfrt3rmaaaaajl-g-h55
                        const has_ask_for_jump_20260205 = localStorage.getItem('has_ask_for_jump_20260205');
                        if (!currentGameId && data.games.length === 0 && !has_ask_for_jump_20260205) {
                            swal({
                                title: "æ¸¸æˆIDä¸ºç©º",
                                text: "æ‚¨æ˜¯å¦è¦å‰å¾€å®‰è£…ç¬¬äº”äººæ ¼æ–°å¼•æ“ï¼Ÿ",
                                icon: "info",
                                buttons: ["å–æ¶ˆ", "è·³è½¬"],
                            }).then((willJump) => {
                                if (willJump) {
                                    localStorage.setItem('has_ask_for_jump_20260205', 'true');
                                    window.location.href = 'https://localhost/_idv-login/index?game_id=aecfrt3rmaaaaajl-g-h55';
                                }
                            });
                        }
                        // æ·»åŠ æ¸¸æˆé€‰é¡¹
                        data.games.forEach(game => {
                            const option = document.createElement('option');
                            option.value = game.game_id;
                            option.text = game.name || game.game_id;
                            option.selected = cmpGameId(game.game_id, currentGameId);
                            gameSelect.appendChild(option);
                        });

                        // å¦‚æœæ²¡æœ‰å½“å‰æ¸¸æˆIDæˆ–åˆ—è¡¨ä¸­æ²¡æœ‰æ­¤æ¸¸æˆ
                        if (!currentGameId && data.games.length > 0) {
                            switchGame(data.games[0].game_id);
                        }
                        //å¦‚æœå½“å‰æœ‰idä½†æ˜¯åˆ—è¡¨ä¸­æ²¡æœ‰ï¼Œå±•ç¤ºå½“å‰id
                        has_match = false;
                        for (var i = 0; i < data.games.length; i++) {
                            if (cmpGameId(data.games[i].game_id, currentGameId)) {
                                has_match = true;
                                break;
                            }
                        }
                        if (!has_match) {
                            option = document.createElement('option');
                            option.value = currentGameId;
                            option.text = currentGameId;
                            option.selected = true;
                            gameSelect.appendChild(option);
                        }
                    } else {
                        console.error('è·å–æ¸¸æˆåˆ—è¡¨å¤±è´¥');
                        document.getElementById('gameSelect').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    }
                });
        }

        // è‡ªåŠ¨å¯åŠ¨ç›¸å…³å‡½æ•°
        function loadAutoStartSettings() {
            const game_id = getQueryVariable("game_id");
            fetch(`/_idv-login/get-game-auto-start?game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateAutoStartUI(data.enabled, data.path);
                    } else {
                        swal({
                            title: "è·å–è‡ªåŠ¨å¯åŠ¨è®¾ç½®å¤±è´¥",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                });
        }

        function updateAutoStartUI(enabled, path) {
            const statusElement = document.getElementById('autoStartStatus');
            const pathElement = document.getElementById('autoStartPath');
            const setBtn = document.getElementById('setAutoStartBtn');
            const disableBtn = document.getElementById('disableAutoStartBtn');
            const startBtn = document.getElementById('startGameBtn');

            statusElement.textContent = enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
            statusElement.className = enabled ? 'ms-2 badge bg-success' : 'ms-2 badge bg-secondary';

            if (path) {
                pathElement.textContent = path;
                pathElement.title = path; // æ·»åŠ å®Œæ•´è·¯å¾„ä½œä¸ºæç¤º
            } else {
                pathElement.textContent = 'æœªè®¾ç½®';
                pathElement.title = '';
            }

            setBtn.disabled = enabled;
            disableBtn.disabled = !enabled;
            startBtn.disabled =  !path;
        }

        function setAutoStart(enabled) {
            const game_id = getQueryVariable("game_id");
            fetch(`/_idv-login/set-game-auto-start?game_id=${game_id}&enabled=${enabled}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateAutoStartUI(data.enabled, data.path);
                        if (enabled) {
                            if (data.path) {
                                swal({
                                    title: "è®¾ç½®æˆåŠŸ",
                                    text: "å·²æˆåŠŸè®¾ç½®æ¸¸æˆè‡ªåŠ¨å¯åŠ¨",
                                    icon: "success",
                                    button: "ç¡®å®š",
                                });
                            } else {
                                swal({
                                    title: "è®¾ç½®å·²å–æ¶ˆ",
                                    text: "å–æ¶ˆäº†æ¸¸æˆè·¯å¾„é€‰æ‹©ï¼Œæœªå¯ç”¨è‡ªåŠ¨å¯åŠ¨",
                                    icon: "info",
                                    button: "ç¡®å®š",
                                });
                            }
                        } else {
                            swal({
                                title: "å·²ç¦ç”¨",
                                text: "å·²ç¦ç”¨æ¸¸æˆè‡ªåŠ¨å¯åŠ¨åŠŸèƒ½",
                                icon: "info",
                                button: "ç¡®å®š",
                            });
                        }
                    } else {
                        swal({
                            title: "è®¾ç½®å¤±è´¥",
                            text: data.error || 'æœªçŸ¥é”™è¯¯',
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                });
        }

        function startGame() {
            const game_id = getQueryVariable("game_id");

            swal({
                title: "æ­£åœ¨å¯åŠ¨æ¸¸æˆ",
                text: "è¯·ç¨å€™...",
                icon: "info",
                buttons: false,
                closeOnClickOutside: false,
            });

            fetch(`/_idv-login/start-game?game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    swal.close();
                    if (data.success) {
                        swal({
                            title: "æ¸¸æˆå¯åŠ¨ä¸­",
                            text: "å¦‚æœæ¸¸æˆæ²¡æœ‰è‡ªåŠ¨å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æ¸¸æˆè·¯å¾„æ˜¯å¦æ­£ç¡®",
                            icon: "success",
                            button: "ç¡®å®š",
                        });
                    } else {
                        swal({
                            title: "å¯åŠ¨å¤±è´¥",
                            text: data.error || 'æœªçŸ¥é”™è¯¯',
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                });
        }

        let launcherState = null;
        let updateRequired = false;

        function formatSize(bytes) {
            if (bytes === null || bytes === undefined) return '-';
            const value = Number(bytes);
            if (!Number.isFinite(value)) return '-';
            if (value <= 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = value;
            let idx = 0;
            while (size >= 1024 && idx < units.length - 1) {
                size /= 1024;
                idx += 1;
            }
            return `${size.toFixed(size >= 10 || idx === 0 ? 0 : 2)} ${units[idx]}`;
        }

        function markUpdateRequired() {
            updateRequired = true;
            const statusLight = document.getElementById('statusLight');
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusLight) statusLight.className = 'status-light warning';
            if (statusText) statusText.textContent = 'è¯·æ›´æ–°å·¥å…·';
            if (statusIndicator) statusIndicator.title = 'å·¥å…·ç‰ˆæœ¬è¿‡æ—§ï¼Œè¯·æ›´æ–°';
        }

        function fetchLauncherJson(url, options) {
            return fetch(url, options).then(response => {
                if (response.status === 404) {
                    markUpdateRequired();
                    const err = new Error('not_found');
                    err.isNotFound = true;
                    throw err;
                }
                return response.json();
            });
        }

        function loadLauncherStatus() {
            const game_id = getQueryVariable("game_id");
            if (!game_id) return;
            fetchLauncherJson(`/_idv-login/launcher-status?game_id=${game_id}`)
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'è·å–å¯åŠ¨å™¨ä¿¡æ¯å¤±è´¥');
                    }
                    launcherState = data;
                    renderLauncherDistributionOptions();
                    updateLauncherDisplay();
                })
                .catch(error => {
                    if (error && error.isNotFound) {
                        return;
                    }
                    launcherState = null;
                    document.getElementById('launcherTitle').textContent = 'å¯åŠ¨å™¨ä¿¡æ¯åŠ è½½å¤±è´¥';
                });
        }

        function renderLauncherDistributionOptions() {
            const select = document.getElementById('launcherDistributionSelect');
            select.innerHTML = '';
            if (!launcherState || !launcherState.distributions || launcherState.distributions.length === 0) {
                select.innerHTML = '<option value="" disabled selected>æš‚æ— ç‰ˆæœ¬</option>';
                return;
            }
            const defaultId = launcherState.game.default_distribution;
            launcherState.distributions.forEach(item => {
                const option = document.createElement('option');
                option.value = item.distribution_id;
                option.text = `åˆ†å‘ ${item.distribution_id}`;
                if (String(item.distribution_id) === String(defaultId)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function updateLauncherDisplay() {
            if (!launcherState) return;
            const select = document.getElementById('launcherDistributionSelect');
            let distId = select.value;
            if (!distId && launcherState.distributions.length) {
                distId = launcherState.distributions[0].distribution_id;
                select.value = distId;
            }
            const dist = launcherState.distributions.find(item => String(item.distribution_id) === String(distId));
            const launcher = dist ? (dist.launcher || {}) : {};

            document.getElementById('launcherTitle').textContent = launcher.display_name || launcher.app_name || launcherState.game_id;
            document.getElementById('launcherSubTitle').textContent = launcher.app_name || launcher.display_name || 'å¯åŠ¨å™¨ä¿¡æ¯';
            document.getElementById('launcherDeveloper').textContent = launcher.developer || '-';
            document.getElementById('launcherPublisher').textContent = launcher.publisher || '-';
            document.getElementById('launcherLocalVersion').textContent = launcherState.game.version || 'æœªçŸ¥';
            document.getElementById('launcherTargetVersion').textContent = dist && dist.target_version ? dist.target_version : 'æœªçŸ¥';
            document.getElementById('launcherStartupPath').textContent = launcher.startup_path || 'æœªçŸ¥';
            document.getElementById('launcherInstallPath').textContent = launcherState.game.installed ? (launcherState.game.path || 'å·²å®‰è£…') : 'æœªå®‰è£…';

            const iconEl = document.getElementById('launcherIcon');
            const iconSrc = launcher.logo || launcher.icon || '';
            if (iconSrc) {
                iconEl.src = iconSrc;
                iconEl.classList.remove('hidden');
            } else {
                iconEl.classList.add('hidden');
            }

            const bgEl = document.getElementById('launcherMainImage');
            const bgSrc = launcher.main_image || '';
            if (bgEl) {
                if (bgSrc) {
                    bgEl.style.backgroundImage = `url('${bgSrc}')`;
                    bgEl.style.display = 'block';
                } else {
                    bgEl.style.display = 'none';
                }
            }

            const badges = [];
            badges.push({ text: launcherState.game.installed ? 'å·²å®‰è£…' : 'æœªå®‰è£…', color: launcherState.game.installed ? 'success' : 'secondary' });
            badges.push({ text: dist && dist.can_update ? 'å¯æ£€æŸ¥æ›´æ–°' : 'æ— éœ€æ›´æ–°', color: dist && dist.can_update ? 'warning' : 'secondary' });
            badges.push({ text: dist && dist.can_download ? 'å¯ä¸‹è½½' : 'ä¸å¯ä¸‹è½½', color: dist && dist.can_download ? 'info' : 'secondary' });
            badges.push({ text: launcherState.game.can_convert ? 'å¯å¤šå¼€' : 'ä¸å¯å¤šå¼€', color: launcherState.game.can_convert ? 'primary' : 'secondary' });
            const badgeContainer = document.getElementById('launcherStatusBadges');
            badgeContainer.innerHTML = '';
            badges.forEach(item => {
                const span = document.createElement('span');
                span.className = `badge bg-${item.color}`;
                span.textContent = item.text;
                badgeContainer.appendChild(span);
            });

            const installBtn = document.getElementById('launcherInstallBtn');
            const updateBtn = document.getElementById('launcherUpdateBtn');
            
            const importListBtn = document.getElementById('launcherImportFeverListBtn');
            installBtn.disabled = launcherState.game.installed || !(dist && dist.can_download);
            //å¦‚æœå·²ç»å®‰è£…ï¼Œä¸”èƒ½ä¸‹è½½ï¼Œåˆ™ä¿®æ”¹æŒ‰é’®å­—æ ·ä¸ºé‡æ–°å®‰è£…å¹¶å¯ç”¨
            if (launcherState.game.installed && dist && dist.can_download) {
                installBtn.textContent = 'é‡æ–°å®‰è£…æˆ–ä»æ—§åŒ…ä½“è¿ç§»';
                updateBtn.textContent = 'æ£€æŸ¥æ›´æ–°';
                installBtn.disabled = false;
                updateBtn.disabled = false;
            } else if(dist && dist.can_download) {
                installBtn.disabled=false;
            }
            
            updateBtn.disabled = !(dist && dist.can_update);

            importListBtn.disabled = false;

        }

        function installLauncher() {
            if (!launcherState) return;
            const distId = document.getElementById('launcherDistributionSelect').value;
            if (!distId) return;
            swal({
                title: "å¼€å§‹å®‰è£…",
                text: "è¯·é€‰æ‹©å®‰è£…ç›®å½•å¹¶ç­‰å¾…ä¸‹è½½å®Œæˆã€‚å¦‚æœæ‰¾ä¸åˆ°å¼¹çª—ï¼Œå…ˆç¼©å°æµè§ˆå™¨ï¼Œçª—å£å¯èƒ½æ˜¯è¢«æŒ¡ä½äº†ã€‚å®‰è£…è¯·é€‰æ‹©ç©ºç›®å½•ï¼Œä¸è¦é€‰æ‹©æ—§ç‰ˆæœ¬æ‰€åœ¨ç›®å½•ã€‚",
                icon: "info",
                buttons: false,
                closeOnClickOutside: false,
            });
            fetchLauncherJson(`/_idv-login/launcher-install?game_id=${launcherState.game_id}&distribution_id=${distId}`)
                .then(data => {
                    swal.close();
                    if (data.success) {
                        swal({
                            title: "å®‰è£…å¼€å§‹",
                            text: "ä¸‹è½½å·²ç»å¼€å§‹",
                            icon: "success",
                            button: "ç¡®å®š",
                        }).then(() => {
                            loadGameList();
                            loadLauncherStatus();
                        });
                    } else {
                        swal({
                            title: "å®‰è£…å¤±è´¥",
                            text: data.error || "å®‰è£…è¿‡ç¨‹å¤±è´¥",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                })
                .catch(error => {
                    if (error && error.isNotFound) {
                        swal.close();
                        return;
                    }
                    swal({
                        title: "è¯·æ±‚å¤±è´¥",
                        text: "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨",
                        icon: "error",
                        button: "ç¡®å®š",
                    });
                });
        }

        function updateLauncher() {
            if (!launcherState) return;
            const distId = document.getElementById('launcherDistributionSelect').value;
            if (!distId) return;
            fetchLauncherJson(`/_idv-login/launcher-update-info?game_id=${launcherState.game_id}&distribution_id=${distId}`)
                .then(info => {
                    if (!info.success) {
                        throw new Error(info.error || 'è·å–æ›´æ–°ä¿¡æ¯å¤±è´¥');
                    }
                    //å¦‚æœä¸‹è½½æ–‡ä»¶å¤§å°æ˜¯96Bï¼Œè€Œä¸”éœ€è¦æ›´æ–°æ–‡ä»¶çš„æ•°é‡æ˜¯1ï¼Œåˆ™æç¤ºç”¨æˆ·å·²ç»å®Œæˆç»•è¿‡å‘çƒ§å¹³å°å¤„ç†ï¼Œæ— éœ€æ›´æ–°
                    //if (info.download_bytes==96 && info.file_count==1){
                    //    return swal({
                    //        title: "æ­å–œ",
                    //        text: "å·²ç»å®Œæˆç»•è¿‡å‘çƒ§å¹³å°å¤„ç†ï¼Œæ— éœ€æ›´æ–°ã€‚è¿™ä¸ªå¼¹çª—å°†åœ¨ä¸‹ä¸€ä¸ªæ›´æ–°ä¸­å»é™¤OVO",
                    //        icon: "info",
                    //        button: "ç¡®å®š",
                    //    }).then(() => false);
                    //}
                    const downloadText = info.needs_update
                        ? `éœ€è¦ä¸‹è½½ï¼š${formatSize(info.download_bytes)}ï¼ˆ${info.file_count}ä¸ªæ–‡ä»¶ï¼‰`
                        : 'æ— éœ€ä¸‹è½½ï¼Œå·²æ˜¯æœ€æ–°ç‰ˆæœ¬';
                    const diskText = `ç£ç›˜å‰©ä½™ï¼š${formatSize(info.disk_free_bytes)}`;
                    return swal({
                        title: "æ›´æ–°æç¤º",
                        text: `${downloadText}\n${diskText}\nå¦‚æœæ‚¨æ˜¯æ—§åŒ…ä½“ï¼Œè¯·é€‰æ‹©â€œé‡æ–°å®‰è£…æˆ–ä»æ—§åŒ…ä½“è¿ç§»â€ï¼Œå¹¶ä¸”åœ¨ä¸€ä¸ªç©ºç›®å½•ä¸‹ä¸‹è½½æ–°å¼•æ“\nå¦‚æœæ‚¨æ˜¯æ–°åŒ…ä½“ï¼Œç‚¹å‡»ç»§ç»­æ›´æ–°ï¼Œå°†ä¼šæ ¡éªŒå¹¶æ›´æ–°æœ¬åœ°å·²æœ‰çš„æ–°å¼•æ“ï¼Œå¹¶ä¸”åˆ›å»ºå¿«æ·æ–¹å¼`,
                        icon: "info",
                        buttons: ["å–æ¶ˆ", "ç»§ç»­æ›´æ–°"],
                    });
                })
                .then(shouldUpdate => {
                    if (!shouldUpdate) return;
                    swal({
                        title: "æ­£åœ¨æ›´æ–°",
                        text: "è¯·ç¨å€™...",
                        icon: "info",
                        buttons: false,
                        closeOnClickOutside: false,
                    });
                    return fetchLauncherJson(`/_idv-login/launcher-update?game_id=${launcherState.game_id}&distribution_id=${distId}`);
                })
                .then(data => {
                    if (!data) return;
                    swal.close();
                    if (data.success) {
                        swal({
                            title: "æ›´æ–°å·²åœ¨åå°å¯åŠ¨",
                            text: "è¯·ç•™æ„å·¥å…·çš„æ–°çª—å£ï¼Œåº”è¯¥ä¼šå¯åŠ¨ä¸¤ä¸ªçª—å£ï¼Œå…¶ä¸­ä¸€ä¸ªçª—å£ä¼šå±•ç¤ºè¿›åº¦ï¼æ›´æ–°å®Œå°†ä¼šå¼¹å‡ºæ¸¸æˆæ‰€åœ¨ä½ç½®ï¼Œè¯·æ³¨æ„è®°å½•ã€‚",
                            icon: "success",
                            button: "ç¡®å®š",
                        }).then(() => {
                            loadLauncherStatus();
                        });
                    } else {
                        swal({
                            title: "æ›´æ–°å¤±è´¥",
                            text: data.error || "æ›´æ–°è¿‡ç¨‹å¤±è´¥",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                })
                .catch(error => {
                    if (error && error.isNotFound) {
                        return;
                    }
                    swal({
                        title: "è¯·æ±‚å¤±è´¥",
                        text: "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨",
                        icon: "error",
                        button: "ç¡®å®š",
                    });
                });
        }

        function importFeverLauncher() {
            if (!launcherState) return;
            if (launcherState.game_id!='h55' && launcherState.game_id.endsWith('h55')){
                swal({
                    title: "ä»å‘çƒ§å¹³å°å¯¼å…¥ç¬¬äº”äººæ ¼æ–°å¼•æ“",
                    text: "æ˜¯å¦å¯¼å…¥å·²ç»å®‰è£…çš„ç¬¬äº”äººæ ¼æ–°å¼•æ“ï¼Ÿå¯¼å…¥åï¼Œæ¸¸æˆå¯ä»¥ç›´æ¥å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥ç”¨å·¥å…·å¯åŠ¨ï¼Œå®ç°å…æ‰«ç åŠŸèƒ½ï¼Œä¸æ—§å¼•æ“çš„ç™»å½•ä½“éªŒä¸€è‡´ã€‚",
                    icon: "warning",
                    buttons: ["å–æ¶ˆ", "æˆ‘å·²ç»åœ¨å‘çƒ§å¹³å°å®‰è£…æ¸¸æˆï¼Œç»§ç»­å¯¼å…¥"],
                }).then(shouldImport => {
                    if (!shouldImport) return;
                    const url = new URL(window.location.href);
                    url.searchParams.set('game_id', "h55");
                    url.searchParams.set('import_from_fever_now', "1");
                    window.location = url;
                });
                return;
            }
            swal({
                title: "å¯¼å…¥ä¸­...",
                text: "æ­£åœ¨å¯¼å…¥Feverå¹³å°æ¸¸æˆè®°å½•",
                icon: "info",
                buttons: false,
                closeOnClickOutside: false,
            });
            fetchLauncherJson(`/_idv-login/launcher-import-fever?game_id=${launcherState.game_id}`)
                .then(data => {
                    swal.close();
                    if (data.success) {
                        swal({
                            title: "å¯¼å…¥å®Œæˆ",
                            icon: "success",
                            button: "ç¡®å®š",
                        }).then(() => {
                            loadGameList();
                            loadLauncherStatus();
                        });
                    } else {
                        swal({
                            title: "å¯¼å…¥å¤±è´¥",
                            text: data.error || "æœªæ‰¾åˆ°å¯å¯¼å…¥è®°å½•",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                })
                .catch(error => {
                    if (error && error.isNotFound) {
                        swal.close();
                        return;
                    }
                    swal({
                        title: "è¯·æ±‚å¤±è´¥",
                        text: "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨",
                        icon: "error",
                        button: "ç¡®å®š",
                    });
                });
        }

        function importFeverLauncherList() {
            swal({
                title: "è·å–å‘çƒ§å¹³å°æ¸¸æˆ...",
                text: "æ­£åœ¨åŠ è½½å·²å®‰è£…æ¸¸æˆåˆ—è¡¨",
                icon: "info",
                buttons: false,
                closeOnClickOutside: false,
            });
            fetchLauncherJson(`/_idv-login/fever-games`)
                .then(data => {
                    swal.close();
                    if (!data.success || !data.games || data.games.length === 0) {
                        throw new Error(data.error || "æœªæ‰¾åˆ°å¯å¯¼å…¥è®°å½•");
                    }
                    const select = document.createElement("select");
                    select.className = "form-select";
                    data.games.forEach(item => {
                        const option = document.createElement("option");
                        const title = item.display_name || item.game_id;
                        option.value = item.game_id;
                        option.textContent = `${title} (${item.game_id})`;
                        select.appendChild(option);
                    });
                    return swal({
                        title: "é€‰æ‹©è¦å¯¼å…¥çš„æ¸¸æˆ",
                        content: select,
                        buttons: ["å–æ¶ˆ", "å¯¼å…¥"],
                    }).then(shouldImport => {
                        if (!shouldImport) return null;
                        return { selectedId: select.value };
                    });
                })
                .then(payload => {
                    if (!payload) return;
                    swal({
                        title: "å¯¼å…¥ä¸­...",
                        text: "æ­£åœ¨å¯¼å…¥Feverå¹³å°æ¸¸æˆè®°å½•",
                        icon: "info",
                        buttons: false,
                        closeOnClickOutside: false,
                    });
                    return fetchLauncherJson(`/_idv-login/launcher-import-fever?game_id=${payload.selectedId}`);
                })
                .then(data => {
                    if (!data) return;
                    swal.close();
                    if (data.success) {
                        swal({
                            title: "å¯¼å…¥å®Œæˆ",
                            icon: "success",
                            button: "ç¡®å®š",
                        }).then(() => {
                            loadGameList();
                            loadLauncherStatus();
                        });
                    } else {
                        swal({
                            title: "å¯¼å…¥å¤±è´¥",
                            text: data.error || "æœªæ‰¾åˆ°å¯å¯¼å…¥è®°å½•",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                })
                .catch(error => {
                    if (error && error.isNotFound) {
                        swal.close();
                        return;
                    }
                    swal({
                        title: "è¯·æ±‚å¤±è´¥",
                        text: "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨",
                        icon: "error",
                        button: "ç¡®å®š",
                    });
                });
        }

        function showCloudSyncPolicy() {
            fetch('/_idv-login/cloud-sync/policy')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error('åŠ è½½è¯´æ˜å¤±è´¥');
                    }
                    const p = data.policy || {};
                    const text = [
                        `å­˜å‚¨åŸç†ï¼š${p.storage || ''}`,
                        '',
                        'è®°ä½å¯†ç çº§åˆ«ï¼š',
                        `- ä¸è®°ä½ä¸»å¯†é’¥ï¼š${(p.credential_levels || {}).none || ''}`,
                        `- è®°ä½ä¸»å¯†é’¥ï¼š${(p.credential_levels || {}).master_key || ''}`,
                        '',
                        'æƒé™è¯´æ˜ï¼š',
                        `- ä¸»å¯†é’¥ï¼š${(p.permissions || {}).master_key || ''}`,
                    ].join('\n');
                    swal({
                        title: 'äº‘åŒæ­¥è¯´æ˜',
                        text,
                        icon: 'info',
                        button: 'æˆ‘å·²äº†è§£',
                    });
                })
                .catch(() => {
                    swal({ title: 'åŠ è½½å¤±è´¥', text: 'æ— æ³•åŠ è½½äº‘åŒæ­¥è¯´æ˜', icon: 'error', button: 'ç¡®å®š' });
                });
        }

        function _collectCloudSyncScopeUuids(scopeType) {
            if (scopeType !== 'selected') return [];
            const selectedUuids = [];
            document.querySelectorAll('.account-checkbox:checked').forEach(checkbox => {
                selectedUuids.push(checkbox.value);
            });
            return selectedUuids;
        }

        const CLOUD_SYNC_POLICY_ACK_KEY = 'cloudSyncWizardPolicyAck';

        function _isCloudSyncPolicyAcked() {
            return localStorage.getItem(CLOUD_SYNC_POLICY_ACK_KEY) === '1';
        }

        function _syncCloudSyncPolicyStateText() {
            const stateEl = document.getElementById('cloudSyncPolicyStateText');
            if (!stateEl) return;
            const acked = _isCloudSyncPolicyAcked();
            stateEl.className = acked ? 'small text-success' : 'small text-muted';
            stateEl.textContent = acked
                ? 'è®¸å¯çŠ¶æ€ï¼šå·²åŒæ„ï¼ˆæ¥è‡ªå‘å¯¼ç¬¬ä¸€æ­¥ï¼‰'
                : 'è®¸å¯çŠ¶æ€ï¼šæœªåŒæ„ï¼ˆè¯·å…ˆå®Œæˆé…ç½®å‘å¯¼ç¬¬ä¸€æ­¥ï¼‰';
        }

        function applyCloudSyncCardAvailability() {
            const bodyEl = document.getElementById('cloudSyncCardBody');
            if (!bodyEl) return;
            const acked = _isCloudSyncPolicyAcked();

            let lockTip = document.getElementById('cloudSyncLockTip');
            if (!lockTip) {
                lockTip = document.createElement('div');
                lockTip.id = 'cloudSyncLockTip';
                lockTip.className = 'alert alert-warning mb-3';
                bodyEl.prepend(lockTip);
            }
            lockTip.textContent = 'è¯·å…ˆç‚¹å‡»å³ä¸Šè§’â€œé…ç½®å‘å¯¼â€ï¼Œåœ¨ç¬¬ä¸€æ­¥å‹¾é€‰å¹¶ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€åï¼Œæ‰å¯ä½¿ç”¨äº‘åŒæ­¥é¢æ¿ã€‚';
            lockTip.style.display = acked ? 'none' : 'block';

            const controls = bodyEl.querySelectorAll('input, select, textarea, button');
            controls.forEach(control => {
                control.disabled = !acked;
            });

            _syncCloudSyncPolicyStateText();
        }

        function _setCloudSyncPolicyAcked(acked) {
            localStorage.setItem(CLOUD_SYNC_POLICY_ACK_KEY, acked ? '1' : '0');
            applyCloudSyncCardAvailability();
        }

        function _ensureCloudSyncPolicyAcked(silent = false) {
            const acked = _isCloudSyncPolicyAcked();
            if (!acked && !silent) {
                swal({
                    title: 'è¯·å…ˆå®Œæˆå‘å¯¼è®¸å¯',
                    text: 'è¯·å…ˆæ‰“å¼€â€œé…ç½®å‘å¯¼â€ï¼Œåœ¨ç¬¬ä¸€æ­¥å‹¾é€‰å¹¶ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€åå†ä½¿ç”¨äº‘åŒæ­¥ã€‚',
                    icon: 'warning',
                    button: 'ç¡®å®š',
                });
            }
            return acked;
        }

        function _buildCloudSyncPayload() {
            const scopeType = document.getElementById('cloudSyncScopeType').value;
            const expireSeconds = parseInt(document.getElementById('cloudSyncExpireAt').value) || 259200;

            const payload = {
                master_key: document.getElementById('cloudSyncMasterKey').value,
                remember_level: document.getElementById('cloudSyncRememberLevel').value,
                sync_direction: document.getElementById('cloudSyncDirection').value,
                auto_sync: document.getElementById('cloudSyncAutoSync').checked,
                consent_ack: _isCloudSyncPolicyAcked(),
                scope_type: scopeType,
                scope_game_id: getQueryVariable('game_id'),
                scope_uuids: _collectCloudSyncScopeUuids(scopeType),
                expire_time: expireSeconds,
            };
            return payload;
        }

        function _setCloudSyncExpireAtFromSeconds(expireSeconds) {
            const val = String(expireSeconds || 259200);
            const el = document.getElementById('cloudSyncExpireAt');
            let found = false;
            for (let i = 0; i < el.options.length; i++) {
                if (el.options[i].value === val) {
                    el.value = val;
                    found = true;
                    break;
                }
            }
            if (!found) {
                 el.value = "259200"; 
            }
        }

        function _downloadCloudSyncMasterKeyTxt(masterKey) {
            const key = String(masterKey || '').trim();
            if (!key) {
                swal('æ— æ³•ä¸‹è½½', 'ä¸»å¯†é’¥ä¸ºç©ºï¼Œè¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥ä¸»å¯†é’¥', 'error');
                return;
            }
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
            const fileName = `idv-login-master-key-${timestamp}.txt`;
            const content = [
                'IDV Login äº‘åŒæ­¥ä¸»å¯†é’¥',
                'è¯·å¦¥å–„ä¿ç®¡ï¼Œæ³„éœ²å°†å¯¼è‡´äº‘ç«¯å¯†æ–‡å¯è¢«è§£å¯†ã€‚',
                '',
                `master_key=${key}`,
                ''
            ].join('\n');

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = fileName;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            setTimeout(() => {
                URL.revokeObjectURL(url);
                if (document.body.contains(downloadLink)) {
                    document.body.removeChild(downloadLink);
                }
            }, 1000);
        }

        function _getCloudSyncPanelCollapsed() {
            const val = localStorage.getItem('cloudSyncPanelCollapsed');
            if (val === null) {
                return true;
            }
            return val === '1';
        }

        function _setCloudSyncPanelCollapsed(collapsed) {
            localStorage.setItem('cloudSyncPanelCollapsed', collapsed ? '1' : '0');
        }

        function applyCloudSyncPanelState() {
            const collapsed = _getCloudSyncPanelCollapsed();
            const bodyEl = document.getElementById('cloudSyncCardBody');
            const btnEl = document.getElementById('cloudSyncToggleBtn');
            if (bodyEl) {
                bodyEl.style.display = collapsed ? 'none' : 'block';
            }
            if (btnEl) {
                btnEl.innerHTML = collapsed
                    ? '<i class="bi bi-chevron-right me-1"></i>å±•å¼€'
                    : '<i class="bi bi-chevron-down me-1"></i>æ”¶èµ·';
            }
            applyCloudSyncCardAvailability();
        }

        function toggleCloudSyncPanel() {
            const collapsed = _getCloudSyncPanelCollapsed();
            _setCloudSyncPanelCollapsed(!collapsed);
            applyCloudSyncPanelState();
        }

        function _evaluateMasterKeyStrength(masterKey) {
            const key = masterKey || '';
            const hasUpper = /[A-Z]/.test(key);
            const hasLower = /[a-z]/.test(key);
            const hasDigit = /\d/.test(key);
            const hasSymbol = /[^A-Za-z0-9]/.test(key);
            const classes = [hasUpper, hasLower, hasDigit, hasSymbol].filter(Boolean).length;
            const valid = key.length >= 12 && classes >= 3;
            return { valid, length: key.length, classes, hasUpper, hasLower, hasDigit, hasSymbol };
        }

        function updateCloudSyncMasterKeyStrength() {
            const key = document.getElementById('cloudSyncMasterKey').value;
            const info = _evaluateMasterKeyStrength(key);
            const hintEl = document.getElementById('cloudSyncKeyStrength');
            if (!key) {
                hintEl.textContent = 'å¼ºåº¦ï¼šæœªæ£€æµ‹';
                hintEl.className = 'text-muted';
                return;
            }
            if (info.valid) {
                hintEl.textContent = `å¼ºåº¦ï¼šåˆæ ¼ï¼ˆé•¿åº¦${info.length}ï¼Œå­—ç¬¦ç±»${info.classes}/4ï¼‰`;
                hintEl.className = 'text-success';
            } else {
                hintEl.textContent = `å¼ºåº¦ï¼šä¸è¶³ï¼ˆè‡³å°‘12ä½ä¸”åŒ…å«3ç±»å­—ç¬¦ï¼Œå½“å‰é•¿åº¦${info.length}ï¼Œå­—ç¬¦ç±»${info.classes}/4ï¼‰`;
                hintEl.className = 'text-danger';
            }
        }


        function loadCloudSyncSettings() {
            fetch('/_idv-login/cloud-sync/settings')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) return;
                    const settings = data.settings || {};
                    document.getElementById('cloudSyncMasterKey').value = settings.saved_master_key || '';
                    document.getElementById('cloudSyncRememberLevel').value = settings.remember_level || 'none';
                    document.getElementById('cloudSyncDirection').value = settings.sync_direction || 'bidirectional';
                    document.getElementById('cloudSyncAutoSync').checked = !!settings.auto_sync;
                    document.getElementById('cloudSyncScopeType').value = settings.scope_type || 'all';
                    _setCloudSyncExpireAtFromSeconds(settings.expire_time || 259200);
                    updateCloudSyncMasterKeyStrength();
                    applyCloudSyncCardAvailability();

                    if (settings.auto_sync) {
                        runCloudSync('auto', true);
                    }
                });
        }

        function saveCloudSyncSettings(options) {
            const opts = options || {};
            if (!_ensureCloudSyncPolicyAcked()) {
                return;
            }
            const payload = _buildCloudSyncPayload();
            const keyInfo = _evaluateMasterKeyStrength(payload.master_key);
            if (payload.master_key && !keyInfo.valid) {
                swal({ title: 'ä¸»å¯†é’¥å¼ºåº¦ä¸è¶³', text: 'è‡³å°‘12ä½ï¼Œä¸”åŒ…å«å¤§å°å†™å­—æ¯/æ•°å­—/ç¬¦å·ä¸­çš„3ç±»', icon: 'warning', button: 'ç¡®å®š' });
                return;
            }
            fetch('/_idv-login/cloud-sync/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (opts.silentSuccess) {
                            if (typeof opts.onSuccess === 'function') {
                                opts.onSuccess();
                            }
                        } else {
                            swal({ title: 'å·²ä¿å­˜', text: 'äº‘åŒæ­¥è®¾ç½®å·²æ›´æ–°', icon: 'success', button: 'ç¡®å®š' }).then(() => {
                                if (typeof opts.onSuccess === 'function') {
                                    opts.onSuccess();
                                }
                            });
                        }
                    } else {
                        swal({ title: 'ä¿å­˜å¤±è´¥', text: data.error || 'æœªçŸ¥é”™è¯¯', icon: 'error', button: 'ç¡®å®š' });
                    }
                })
                .catch(() => {
                    swal({ title: 'è¯·æ±‚å¤±è´¥', text: 'æ— æ³•ä¿å­˜äº‘åŒæ­¥è®¾ç½®', icon: 'error', button: 'ç¡®å®š' });
                });
        }

        function runCloudSync(action, silent = false) {
            if (!_ensureCloudSyncPolicyAcked(silent)) {
                return;
            }
            const payload = _buildCloudSyncPayload();
            if (payload.scope_type === 'selected' && (!payload.scope_uuids || payload.scope_uuids.length === 0)) {
                if (!silent) {
                    swal({ title: 'è¯·å…ˆå‹¾é€‰è´¦å·', text: 'å½“å‰èŒƒå›´ä¸ºâ€œä»…å‹¾é€‰è´¦å·â€ï¼Œè¯·å…ˆåœ¨è´¦å·åˆ—è¡¨å‹¾é€‰åå†åŒæ­¥ã€‚', icon: 'warning', button: 'ç¡®å®š' });
                }
                return;
            }
            payload.action = action;
            if (!silent) {
                swal({ title: 'åŒæ­¥ä¸­', text: 'è¯·ç¨å€™...', icon: 'info', buttons: false, closeOnClickOutside: false });
            }
            fetch('/_idv-login/cloud-sync/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(data => {
                    if (!silent) swal.close();
                    if (data.success) {
                        if (!silent) {
                            swal({ title: 'åŒæ­¥å®Œæˆ', text: `æ“ä½œæˆåŠŸï¼š${data.action || action}`, icon: 'success', button: 'ç¡®å®š' })
                                .then(() => location.reload());
                        }
                    } else if (!data.skipped) {
                        if (!silent) {
                            swal({ title: 'åŒæ­¥å¤±è´¥', text: data.error || 'æœªçŸ¥é”™è¯¯', icon: 'error', button: 'ç¡®å®š' });
                        }
                    }
                })
                .catch(() => {
                    if (!silent) {
                        swal.close();
                        swal({ title: 'è¯·æ±‚å¤±è´¥', text: 'äº‘åŒæ­¥è¯·æ±‚å¤±è´¥', icon: 'error', button: 'ç¡®å®š' });
                    }
                });
        }

        function deleteCloudSync() {
            if (!_ensureCloudSyncPolicyAcked()) {
                return;
            }
            const payload = _buildCloudSyncPayload();
            if (!payload.master_key) {
                swal({ title: 'å‚æ•°ä¸è¶³', text: 'åˆ é™¤äº‘åŒæ­¥éœ€è¦ä¸»å¯†é’¥', icon: 'warning', button: 'ç¡®å®š' });
                return;
            }
            swal({
                title: 'ç¡®è®¤åˆ é™¤äº‘åŒæ­¥ï¼Ÿ',
                text: 'è¯¥æ“ä½œä¼šåˆ é™¤äº‘ç«¯å·²æœ‰åŒæ­¥è®°å½•ï¼Œæ— æ³•æ¢å¤ã€‚',
                icon: 'warning',
                buttons: ['å–æ¶ˆ', 'ç¡®è®¤åˆ é™¤'],
                dangerMode: true,
            }).then(willDelete => {
                if (!willDelete) return;
                fetch('/_idv-login/cloud-sync/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            _setCloudSyncPolicyAcked(false);
                            swal({ title: 'åˆ é™¤æˆåŠŸ', text: 'å·²æ’¤é”€äº‘åŒæ­¥è®¸å¯ï¼Œè¯·é‡æ–°é€šè¿‡é…ç½®å‘å¯¼ç¡®è®¤ã€‚', icon: 'success', button: 'ç¡®å®š' });
                        } else {
                            swal({ title: 'åˆ é™¤å¤±è´¥', text: data.error || 'æœªçŸ¥é”™è¯¯', icon: 'error', button: 'ç¡®å®š' });
                        }
                    });
            });
        }

        function viewCloudSyncLogs() {
            if (!_ensureCloudSyncPolicyAcked()) {
                return;
            }
            const payload = _buildCloudSyncPayload();
            if (!payload.master_key) {
                swal({ title: 'å‚æ•°ä¸è¶³', text: 'æŸ¥çœ‹æ—¥å¿—éœ€è¦ä¸»å¯†é’¥', icon: 'warning', button: 'ç¡®å®š' });
                return;
            }
            fetch('/_idv-login/cloud-sync/access-logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        swal({ title: 'è¯»å–å¤±è´¥', text: data.error || 'æœªçŸ¥é”™è¯¯', icon: 'error', button: 'ç¡®å®š' });
                        return;
                    }
                    const logs = (data.logs || []).slice(-20).reverse();
                    const text = logs.length
                        ? logs.map(item => {
                            const actionText = item.action || 'unknown';
                            const atText = item.at ? new Date(item.at * 1000).toLocaleString() : '-';
                            const hostText = (((item.device || {}).hostname) || '-');
                            return `${atText} | ${actionText} | ${hostText}`;
                        }).join('\n')
                        : 'æš‚æ— è®¿é—®æ—¥å¿—';
                    swal({ title: 'æœ€è¿‘è®¿é—®æ—¥å¿—', text, icon: 'info', button: 'ç¡®å®š' });
                })
                .catch(() => {
                    swal({ title: 'è¯·æ±‚å¤±è´¥', text: 'æ— æ³•è¯»å–è®¿é—®æ—¥å¿—', icon: 'error', button: 'ç¡®å®š' });
                });
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶è·å–è´¦å·åˆ—è¡¨
        window.onload = function () {
            //è·å¾—queryå‚æ•°game_id
            game_id = getQueryVariable("game_id");

            const masterKeyInput = document.getElementById('cloudSyncMasterKey');
            if (masterKeyInput) {
                masterKeyInput.addEventListener('input', updateCloudSyncMasterKeyStrength);
            }
            applyCloudSyncPanelState();

            // å¯åŠ¨å·¥å…·çŠ¶æ€æ£€æŸ¥
            startStatusCheck();

            // é¦–å…ˆåŠ è½½æ¸¸æˆåˆ—è¡¨
            loadGameList();

            // åŠ è½½HTTPDNSå±è”½çŠ¶æ€
            loadHttpDnsStatus();

            // å¦‚æœæœ‰game_idï¼ŒåŠ è½½è¯¥æ¸¸æˆçš„è´¦å·å’Œè®¾ç½®
            if (game_id) {
                // åŠ è½½ç™»å½•å»¶è¿Ÿè®¾ç½®
                loadLoginDelay();

                fetch('/_idv-login/list?game_id=' + game_id)
                    .then(response => response.json())
                    .then(data => {
                        var tableBody = document.getElementById('channelTableBody');
                        var noAccountsDiv = document.getElementById('noAccounts');
                        var batchOperationsGroup = document.getElementById('batchOperationsGroup');

                        // æ¸…ç©ºè¡¨æ ¼
                        tableBody.innerHTML = '';

                        if (data.length === 0) {
                            noAccountsDiv.style.display = 'block';
                            batchOperationsGroup.style.display = 'none'; // æ²¡æœ‰è´¦å·æ—¶éšè—æ‰¹é‡æ“ä½œ
                        } else {
                            noAccountsDiv.style.display = 'none';
                            batchOperationsGroup.style.display = 'block'; // æœ‰è´¦å·æ—¶æ˜¾ç¤ºæ‰¹é‡æ“ä½œ

                            data.forEach(channel => {
                                // å¦‚æœuuidä»¥neteaseå¼€å¤´ï¼Œåˆ™è·³è¿‡ä¸æ˜¾ç¤º
                                if (channel.uuid.startsWith('netease')) {
                                    return;
                                }

                                var row = tableBody.insertRow();
                                row.insertCell().innerHTML = `<input type="checkbox" class="account-checkbox" value="${channel.uuid}">`;

                                var uuidCell = row.insertCell();
                                uuidCell.innerHTML = `<span class="badge bg-light text-dark">${channel.uuid}</span>`;
                                uuidCell.title = channel.uuid;

                                row.insertCell().innerHTML = channel.name;
                                row.insertCell().innerHTML = `<small>${timeStampToLocalTime(channel.last_login_time)}</small>`;

                                var actionsCell = row.insertCell();
                                actionsCell.innerHTML = `
                                    <div class="actions-container">
                                        <div class="action-button">
                                            <button onclick="switchChannel('${channel.uuid}')" class="btn btn-sm btn-primary btn-action">
                                                <i class="bi bi-box-arrow-in-right"></i>
                                            </button>
                                            <span class="action-label">ç™»å½•</span>
                                        </div>
                                        <div class="action-button">
                                            <button onclick="renameChannel('${channel.uuid}')" class="btn btn-sm btn-info btn-action text-white">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <span class="action-label">æ”¹å</span>
                                        </div>
                                        <div class="action-button">
                                            <button onclick="deleteChannel('${channel.uuid}')" class="btn btn-sm btn-danger btn-action">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            <span class="action-label">åˆ é™¤</span>
                                        </div>
                                        <div class="action-button">
                                            <button onclick="defaultChannel('${channel.uuid}')" class="btn btn-sm btn-success btn-action">
                                                <i class="bi bi-star"></i>
                                            </button>
                                            <span class="action-label">è‡ªåŠ¨ç™»å½•</span>
                                        </div>
                                    </div>
                                `;
                            });

                            // å…¨é€‰åŠŸèƒ½
                            document.getElementById('selectAll').addEventListener('change', function () {
                                const checkboxes = document.querySelectorAll('.account-checkbox');
                                checkboxes.forEach(checkbox => {
                                    checkbox.checked = this.checked;
                                });
                            });
                        }
                    });

                fetch('/_idv-login/manualChannels')
                    .then(response => response.json())
                    .then(data => {
                        var channelSelect = document.getElementById('channelSelect');
                        // æ¸…ç©ºä¸‹æ‹‰æ¡†
                        channelSelect.innerHTML = '';

                        data.forEach(channel => {
                            var option = document.createElement('option');
                            option.value = channel.channel;
                            option.text = channel.name;
                            channelSelect.appendChild(option);
                        });
                    });

                fetch('/_idv-login/defaultChannel?game_id=' + game_id)
                    .then(response => response.json())
                    .then(data => {
                        if (data.uuid != "") {
                            document.getElementById('default').innerText = data.uuid;
                            document.getElementById('default').className = 'badge bg-success text-white p-2';
                        } else {
                            document.getElementById('default').innerText = 'Empty';
                            document.getElementById('default').className = 'badge bg-info text-white p-2';
                        }
                    });

                // è·å–è‡ªåŠ¨å…³é—­çŠ¶æ€
                fetch(`/_idv-login/get-auto-close-state?game_id=${game_id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateAutoCloseButton(data.state);
                        }
                    });

                // åŠ è½½è‡ªåŠ¨å¯åŠ¨è®¾ç½®
                loadAutoStartSettings();
                loadCloudSyncSettings();
                loadLauncherStatus();
                import_from_fever_now = getQueryVariable("import_from_fever_now");
                if (import_from_fever_now!="") {
                    // è§¦å‘å¯¼å…¥æ“ä½œ
                    importFeverLauncher();
                }
            }
        }

        // æ·»åŠ æ–°çš„å‡½æ•°
        function updateAutoCloseButton(state) {
            const btn = document.getElementById('autoCloseBtn');
            if (state) {
                btn.innerHTML = `<i class="bi bi-power me-1"></i>ç™»å½•åè‡ªåŠ¨å…³é—­å·¥å…·ï¼šå¼€å¯`;
                btn.className = 'btn btn-success w-100';
            } else {
                btn.innerHTML = `<i class="bi bi-power me-1"></i>ç™»å½•åè‡ªåŠ¨å…³é—­å·¥å…·ï¼šå…³é—­`;
                btn.className = 'btn btn-outline-secondary w-100';
            }
        }

        function switchAutoClose() {
            game_id = getQueryVariable("game_id");
            fetch(`/_idv-login/switch-auto-close-state?game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateAutoCloseButton(data.state);
                        swal({
                            title: data.state ? "è‡ªåŠ¨å…³é—­å·²å¼€å¯" : "è‡ªåŠ¨å…³é—­å·²å…³é—­",
                            text: data.state ? "ç™»å½•æˆåŠŸåå°†è‡ªåŠ¨å…³é—­å·¥å…·" : "ç™»å½•åå·¥å…·å°†ä¿æŒè¿è¡Œ",
                            icon: "success",
                            button: "ç¡®å®š",
                        });
                    } else {
                        swal({
                            title: "åˆ‡æ¢çŠ¶æ€å¤±è´¥",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                });
        }
        function exportLogs() {
            const downloadLink = document.createElement('a');
            downloadLink.href = '/_idv-login/export-logs';
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);

            // ç›‘å¬ä¸‹è½½å®Œæˆ
            downloadLink.addEventListener('click', function () {
                setTimeout(() => {
                    swal({
                        title: "æ—¥å¿—å¯¼å‡ºæˆåŠŸ",
                        text: "è°ƒè¯•æ—¥å¿—æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ã€‚å…¶ä¸­åŒ…å«æ“ä½œç³»ç»Ÿã€è®¡ç®—æœºã€IPã€å·²å®‰è£…åº”ç”¨åˆ—è¡¨ã€è¿›ç¨‹ã€ä»£ç†çŠ¶æ€ç­‰è¯Šæ–­ä¿¡æ¯ï¼Œåˆ†äº«å‰è¯·æ³¨æ„ä¸ªäººéšç§ã€‚",
                        icon: "success",
                        button: "ç¡®å®š",
                    });
                    document.body.removeChild(downloadLink);
                }, 1000);
            });

            // è§¦å‘ä¸‹è½½
            downloadLink.click();
        }

        // HTTPDNSå±è”½åŠŸèƒ½ç›¸å…³å‡½æ•°
        function loadHttpDnsStatus() {
            fetch('/_idv-login/get-httpdns-status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const toggle = document.getElementById('httpdnsToggle');
                        const statusText = document.getElementById('httpdnsStatusText');

                        toggle.checked = data.enabled;
                        statusText.textContent = data.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                        statusText.className = data.enabled ? 'text-success' : 'text-warning';
                    } else {
                        document.getElementById('httpdnsStatusText').textContent = 'è·å–çŠ¶æ€å¤±è´¥ï¼Œè¯·æ›´æ–°å·¥å…·åˆ°æœ€æ–°ç‰ˆæœ¬';
                        document.getElementById('httpdnsStatusText').className = 'text-danger';
                    }
                })
                .catch(error => {
                    console.error('è·å–HTTPDNSçŠ¶æ€å¤±è´¥:', error);
                    document.getElementById('httpdnsStatusText').textContent = 'è·å–çŠ¶æ€å¤±è´¥';
                    document.getElementById('httpdnsStatusText').className = 'text-danger';
                });
        }

        function toggleHttpDnsBlocking() {
            const toggle = document.getElementById('httpdnsToggle');
            const statusText = document.getElementById('httpdnsStatusText');

            // æ˜¾ç¤ºåˆ‡æ¢ä¸­çŠ¶æ€
            statusText.textContent = 'åˆ‡æ¢ä¸­...';
            statusText.className = 'text-info';

            fetch('/_idv-login/toggle-httpdns-blocking', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        statusText.textContent = data.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                        statusText.className = data.enabled ? 'text-success' : 'text-warning';

                        // æ˜¾ç¤ºæ“ä½œç»“æœ
                        let message = data.enabled ?
                            'HTTPDNSå±è”½å·²å¯ç”¨ï¼Œæ¸¸æˆçš„HTTPDNSæœåŠ¡å°†è¢«å±è”½' :
                            'HTTPDNSå±è”½å·²ç¦ç”¨';

                        if (!data.enabled && data.unblock_result) {
                            message += '\né˜²ç«å¢™è§„åˆ™è§£é™¤ç»“æœï¼š' + data.unblock_result;
                        }

                        swal({
                            title: data.enabled ? "HTTPDNSå±è”½å·²å¯ç”¨" : "HTTPDNSå±è”½å·²ç¦ç”¨",
                            text: message + (data.warning ? '\n\nâš ï¸ ' + data.warning : ''),
                            icon: "success",
                            button: "ç¡®å®š",
                        });
                    } else {
                        // æ“ä½œå¤±è´¥ï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                        toggle.checked = !toggle.checked;
                        statusText.textContent = 'åˆ‡æ¢å¤±è´¥ï¼Œè¯·æ›´æ–°å·¥å…·åˆ°æœ€æ–°ç‰ˆæœ¬å¹¶æ£€æŸ¥æ—¥å¿—';
                        statusText.className = 'text-danger';

                        swal({
                            title: "æ“ä½œå¤±è´¥",
                            text: data.message || "åˆ‡æ¢HTTPDNSå±è”½çŠ¶æ€å¤±è´¥ï¼Œè¯·æ›´æ–°å·¥å…·åˆ°æœ€æ–°ç‰ˆæœ¬å¹¶æ£€æŸ¥æ—¥å¿—",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                })
                .catch(error => {
                    console.error('åˆ‡æ¢HTTPDNSå±è”½å¤±è´¥:', error);
                    // æ“ä½œå¤±è´¥ï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                    toggle.checked = !toggle.checked;
                    statusText.textContent = 'åˆ‡æ¢å¤±è´¥';
                    statusText.className = 'text-danger';

                    swal({
                        title: "ç½‘ç»œé”™è¯¯",
                        text: "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",
                        icon: "error",
                        button: "ç¡®å®š",
                    });
                });
        }

        // å·¥å…·çŠ¶æ€æ£€æŸ¥åŠŸèƒ½
        let statusCheckInterval = null;
        let disconnectedCount = 0;
        let overlayDismissed = false;  // æ ‡è®°ç”¨æˆ·æ˜¯å¦å·²æ‰‹åŠ¨å…³é—­é®ç½©
        const FAQ_URL = 'https://www.yuque.com/keygen/kg2r5k/xl9zosrwviyc54nu';

        function checkToolStatus() {
            const statusLight = document.getElementById('statusLight');
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            const connectionOverlay = document.getElementById('connectionOverlay');

            fetch('/_idv-login/list-games')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // è¿æ¥æˆåŠŸ
                    disconnectedCount = 0;
                    overlayDismissed = false;  // é‡ç½®å…³é—­æ ‡è®°
                    if (updateRequired) {
                        statusLight.className = 'status-light warning';
                        statusText.textContent = 'è¯·æ›´æ–°å·¥å…·';
                        statusIndicator.title = 'å·¥å…·ç‰ˆæœ¬è¿‡æ—§ï¼Œè¯·æ›´æ–°';
                    } else {
                        statusLight.className = 'status-light connected';
                        statusText.textContent = 'å·¥å…·è¿è¡Œä¸­';
                        statusIndicator.title = 'å·¥å…·è¿æ¥æ­£å¸¸';
                    }
                    statusIndicator.style.cursor = 'default';
                    statusIndicator.onclick = null;
                    statusIndicator.classList.remove('disconnected-state');
                    // éšè—é®ç½©å±‚
                    if (connectionOverlay) {
                        connectionOverlay.classList.remove('show');
                    }
                })
                .catch(error => {
                    // è¿æ¥å¤±è´¥
                    disconnectedCount++;
                    statusLight.className = 'status-light disconnected';
                    statusText.textContent = 'å·¥å…·æœªè¿æ¥';
                    statusIndicator.title = 'å·¥å…·è¿æ¥å¤±è´¥ï¼Œç‚¹å‡»æŸ¥çœ‹å¸¸è§é—®é¢˜è§£ç­”';
                    statusIndicator.style.cursor = 'pointer';
                    statusIndicator.classList.add('disconnected-state');
                    statusIndicator.onclick = function () {
                        window.open(FAQ_URL, '_blank');
                    };

                    // å¦‚æœè¿ç»­å¤±è´¥è¶…è¿‡5ç§’ï¼ˆ5æ¬¡æ£€æŸ¥ï¼‰ä¸”ç”¨æˆ·æœªæ‰‹åŠ¨å…³é—­ï¼Œæ˜¾ç¤ºå…¨å±€é®ç½©
                    if (disconnectedCount >= 5 && !overlayDismissed && connectionOverlay && !connectionOverlay.classList.contains('show')) {
                        connectionOverlay.classList.add('show');
                    }
                });
        }

        // æ‰“å¼€FAQå¹¶å…³é—­é®ç½©å±‚
        function openFAQAndCloseOverlay() {
            window.open(FAQ_URL, '_blank');
            dismissOverlay();
        }

        // å…³é—­é®ç½©å±‚
        function dismissOverlay() {
            overlayDismissed = true;  // æ ‡è®°ç”¨æˆ·å·²æ‰‹åŠ¨å…³é—­
            const connectionOverlay = document.getElementById('connectionOverlay');
            if (connectionOverlay) {
                connectionOverlay.classList.remove('show');
            }
        }

        // å¯åŠ¨çŠ¶æ€æ£€æŸ¥
        function startStatusCheck() {
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            checkToolStatus();
            // ç„¶åæ¯1ç§’æ£€æŸ¥ä¸€æ¬¡
            statusCheckInterval = setInterval(checkToolStatus, 1000);
        }

        // åœæ­¢çŠ¶æ€æ£€æŸ¥
        function stopStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }

        function manual() {
            //è·å–channelSelectçš„å€¼
            var selectedChannel = document.getElementById('channelSelect').value;

            if (!selectedChannel) {
                swal({
                    title: "è¯·é€‰æ‹©ç™»å½•æ¸ é“",
                    icon: "warning",
                    button: "ç¡®å®š",
                });
                return;
            }

            let qrPollTimer = null;
            const isWechatMyApp = selectedChannel === 'myapp';

            function showLegacyManualLoadingSwal() {
                swal({
                    title: "æ­£åœ¨å¤„ç†",
                    text: "æ­£åœ¨æ‰§è¡Œæ‰‹åŠ¨ç™»å½•ï¼Œè¯·ç¨å€™...å¦‚æœåœ¨æ­¤ç•Œé¢åœç•™è¿‡ä¹…ï¼Œè¯·å‚è€ƒæ•™ç¨‹æ–‡æ¡£->å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆé—®é¢˜18",
                    icon: "info",
                    buttons: false,
                    closeOnClickOutside: false,
                });
            }

            function stopQrcodePolling() {
                if (qrPollTimer) {
                    clearInterval(qrPollTimer);
                    qrPollTimer = null;
                }
            }

            function startQrcodePolling() {
                const content = document.createElement('div');
                content.innerHTML = `
                    <div style="text-align:center;">
                        <div id="wechat-qrcode-status" style="margin-bottom:10px;color:#6c757d;">æ­£åœ¨è·å–äºŒç»´ç ...</div>
                        <img id="wechat-qrcode-img" alt="å¾®ä¿¡äºŒç»´ç " style="max-width:260px;width:100%;height:auto;border:1px solid #e9ecef;border-radius:8px;display:none;margin:0 auto;" />
                        <div style="margin-top:8px;font-size:12px;color:#6c757d;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç å®Œæˆåº”ç”¨å®ç™»å½•</div>
                    </div>
                `;

                swal({
                    title: "å¾®ä¿¡æ‰«ç ç™»å½•",
                    content,
                    buttons: false,
                    closeOnClickOutside: false,
                    closeOnEsc: false,
                });

                const poll = () => {
                    fetch(`/_idv-login/qrcode?game_id=${encodeURIComponent(game_id)}&_ts=${Date.now()}`)
                        .then(response => response.json())
                        .then(data => {
                            const statusEl = document.getElementById('wechat-qrcode-status');
                            const imgEl = document.getElementById('wechat-qrcode-img');
                            if (!statusEl || !imgEl) return;

                            const statusMap = {
                                idle: 'ç­‰å¾…å¼€å§‹ç™»å½•...',
                                loading: 'æ­£åœ¨è·å–äºŒç»´ç ...',
                                ready: 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç ',
                                scanned: 'æ‰«ç æˆåŠŸï¼Œæ­£åœ¨æ ¡éªŒ...',
                                verified: 'ç™»å½•æ ¡éªŒæˆåŠŸï¼Œæ­£åœ¨å®Œæˆå¯¼å…¥...',
                                failed: 'æ‰«ç æ ¡éªŒå¤±è´¥ï¼Œè¯·é‡è¯•',
                            };
                            statusEl.textContent = statusMap[data.status] || 'æ­£åœ¨å¤„ç†...';

                            if (data.qrcode_base64) {
                                imgEl.src = `data:image/png;base64,${data.qrcode_base64}`;
                                imgEl.style.display = 'block';
                            }
                        })
                        .catch(() => {
                            const statusEl = document.getElementById('wechat-qrcode-status');
                            if (statusEl) {
                                statusEl.textContent = 'äºŒç»´ç è·å–å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...';
                            }
                        });
                };

                poll();
                qrPollTimer = setInterval(poll, 1000);
            }

            if (isWechatMyApp) {
                fetch(`/_idv-login/qrcode?game_id=${encodeURIComponent(game_id)}&_ts=${Date.now()}`)
                    .then(response => {
                        if (response.status === 404) {
                            showLegacyManualLoadingSwal();
                            return;
                        }
                        startQrcodePolling();
                    })
                    .catch(() => {
                        showLegacyManualLoadingSwal();
                    });
            } else {
                showLegacyManualLoadingSwal();
            }

            fetch(`/_idv-login/import?channel=${selectedChannel}&game_id=${game_id}`)
                .then(response => response.json())
                .then(data => {
                    stopQrcodePolling();
                    swal.close();
                    if (data.success) {
                        swal({
                            title: "æ‰§è¡ŒæˆåŠŸ",
                            text: "ç™»å½•æ“ä½œå·²å®Œæˆ",
                            icon: "success",
                            button: "ç¡®å®š",
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        swal({
                            title: "æ‰§è¡Œå¤±è´¥",
                            text: "è¯·æ£€æŸ¥å·¥å…·æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯",
                            icon: "error",
                            button: "ç¡®å®š",
                        });
                    }
                })
                .catch(() => {
                    stopQrcodePolling();
                    swal.close();
                    swal({
                        title: "æ‰§è¡Œå¤±è´¥",
                        text: "è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥å·¥å…·æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯",
                        icon: "error",
                        button: "ç¡®å®š",
                    });
                });
        }
    </script>

    <!-- Cloud Sync Wizard Modal -->
    <div class="modal fade" id="cloudSyncWizardModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="bi bi-magic me-2"></i>äº‘åŒæ­¥é…ç½®å‘å¯¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" id="wizardProgressBar" style="width: 25%"></div>
                    </div>

                    <!-- Step 1: Intro + Mode -->
                    <div class="wizard-step" id="wizardStep1">
                        <div class="text-center mb-4">
                            <i class="bi bi-cloud-arrow-up text-primary" style="font-size: 3rem;"></i>
                            <h3 class="mt-3">æ¬¢è¿ä½¿ç”¨äº‘åŒæ­¥</h3>
                            <p class="text-muted">æœ¬å‘å¯¼å°†å¸®åŠ©æ‚¨å¿«é€Ÿé…ç½®æ¸ é“æœè´¦å·åŒæ­¥åŠŸèƒ½ã€‚</p>
                        </div>
                        <div class="alert alert-info border-0 bg-soft-info">
                            <div class="d-flex">
                                <i class="bi bi-shield-lock-fill fs-4 me-3"></i>
                                <div>
                                    <h5>ä½¿ç”¨é¡»çŸ¥</h5>
                                    <p class="mb-0 small">ç³»ç»Ÿä½¿ç”¨é«˜å¼ºåº¦ AES-SIV åŠ å¯†æ–¹æ¡ˆã€‚æ‚¨çš„æ‰€æœ‰æ•°æ®åœ¨å‘é€åˆ°äº‘ç«¯å‰éƒ½ä¼šè¢«åŠ å¯†ã€‚äº‘ç«¯æœåŠ¡å™¨ï¼ˆWebNoteï¼‰ä»…å­˜å‚¨å¯†æ–‡ï¼Œæ— æ³•æŸ¥çœ‹æ‚¨çš„è´¦å·ä¿¡æ¯ã€‚</p>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="wizardPolicyAck">
                                        <label class="form-check-label small" for="wizardPolicyAck">
                                            æˆ‘å·²é˜…è¯»å¹¶åŒæ„
                                            <a href="https://www.yuque.com/keygen/kg2r5k/pvb2mdma2zpq442g" target="_blank" class="text-decoration-none">è¯¦ç»†è¯´æ˜å’Œéšç§æ”¿ç­–</a>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label fw-bold">è¯·é€‰æ‹©ä½¿ç”¨åœºæ™¯</label>
                            <select class="form-select" id="wizardMode" onchange="wizardOnModeChange()">
                                <option value="import_existing">å¯¼å…¥å·²æœ‰åŒæ­¥ï¼ˆæˆ‘åœ¨å…¶ä»–è®¾å¤‡ä¸Šå·²é…ç½®è¿‡ï¼‰</option>
                                <option value="new_setup">æˆ‘è¿˜æœªè®¾ç½®è¿‡åŒæ­¥</option>
                            </select>
                        </div>
                    </div>

                    <!-- Step 2: Master Key -->
                    <div class="wizard-step" id="wizardStep2" style="display:none;">
                        <h4 class="mb-3">è®¾ç½®ä¸»å¯†é’¥</h4>
                        <p class="text-muted small">ä¸»å¯†é’¥æ˜¯è§£å¯†æ•°æ®çš„å”¯ä¸€å‡­è¯ã€‚ä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬ä¸å­˜å‚¨ä¸»å¯†é’¥æ˜æ–‡ï¼ˆé™¤éæ‚¨é€‰æ‹©æœ¬åœ°è®°ä½ï¼‰ã€‚</p>
                        
                        <div class="card bg-light border-0 mb-4" id="wizardGenerateCard">
                            <div class="card-body text-center">
                                <button class="btn btn-primary btn-lg mb-3" onclick="wizardGenKey()">
                                    <i class="bi bi-dice-5 me-2"></i>ç”Ÿæˆé«˜å¼ºåº¦éšæœºå¯†é’¥
                                </button>
                                <div id="wizardKeyDisplayArea" style="display:none;" class="mt-2 text-start">
                                    <p class="text-danger fw-bold mb-2 text-center"><i class="bi bi-exclamation-triangle me-1"></i>è¯·åŠ¡å¿…ç«‹å³å¤åˆ¶å¹¶ä¿å­˜ä¸‹æ–¹å¯†é’¥ï¼š</p>
                                    <div class="p-3 bg-white border rounded shadow-sm position-relative">
                                        <h4 class="font-monospace text-break mb-0 text-primary user-select-all text-center" id="wizardKeyText"></h4>
                                        <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" onclick="copyWizardKey()">
                                            <i class="bi bi-clipboard"></i> å¤åˆ¶
                                        </button>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <button class="btn btn-link btn-sm text-decoration-none" onclick="wizardTriggerTxtDownload()">
                                            <i class="bi bi-file-earmark-arrow-down"></i> ä¸‹è½½ä¸ºæ–‡æœ¬æ–‡ä»¶
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥ï¼š</label>
                            <input type="text" class="form-control" id="wizardKeyInput" placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥ä¸»å¯†é’¥" oninput="validateWizardKey()">
                            <div id="wizardKeyFeedback" class="form-text"></div>
                            <div class="mt-2">
                                <input type="file" id="wizardKeyFileInput" accept=".txt,text/plain" style="display:none;" onchange="wizardImportKeyFile(event)">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('wizardKeyFileInput').click()">
                                    <i class="bi bi-upload me-1"></i>ä»æ–‡æœ¬æ–‡ä»¶å¯¼å…¥ä¸»å¯†é’¥
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-secondary py-2" id="wizardProbeResult" style="display:none;"></div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">æ˜¯å¦åœ¨æœ¬åœ°è®°ä½ä¸»å¯†é’¥ï¼Ÿ</label>
                            <select class="form-select" id="wizardRemember">
                                <option value="master_key">æ˜¯ï¼Œè®°ä½ä¸»å¯†é’¥ (æ¨èä¸ªäººç”µè„‘ä½¿ç”¨)</option>
                                <option value="none">å¦ï¼Œæ¯æ¬¡åŒæ­¥éƒ½éœ€è¦æ‰‹åŠ¨è¾“å…¥ (å…¬ç”¨ç”µè„‘æ¨è)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Step 3: Options -->
                    <div class="wizard-step" id="wizardStep3" style="display:none;">
                        <h4 class="mb-3">åŒæ­¥é€‰é¡¹è®¾ç½®</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">è´¦å·èŒƒå›´</label>
                                <select class="form-select" id="wizardScope">
                                    <option value="all">æ‰€æœ‰æ¸¸æˆçš„æ‰€æœ‰è´¦å·</option>
                                    <option value="current_game" selected>ä»…å½“å‰é€‰æ‹©çš„æ¸¸æˆ</option>
                                    <option value="selected">ä»…åˆ—è¡¨å‹¾é€‰çš„è´¦å·</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">äº‘ç«¯æ•°æ®ä¿ç•™æ—¶é•¿</label>
                                <select class="form-select" id="wizardExpire">
                                    <option value="3600">1å°æ—¶</option>
                                    <option value="21600">6å°æ—¶</option>
                                    <option value="86400">1å¤©</option>
                                    <option value="259200" selected>3å¤© (é»˜è®¤)</option>
                                    <option value="604800">1å‘¨</option>
                                    <option value="2592000">1ä¸ªæœˆ</option>
                                    <option value="7776000">3ä¸ªæœˆ</option>
                                    <option value="15552000">åŠå¹´</option>
                                    <option value="31536000">1å¹´</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">åŒæ­¥æ–¹å‘</label>
                                <select class="form-select" id="wizardDirection">
                                    <option value="pull">å•å‘ä¸‹è½½ï¼ˆäº‘ç«¯â†’æœ¬åœ°ï¼‰</option>
                                    <option value="push">å•å‘ä¸Šä¼ ï¼ˆæœ¬åœ°â†’äº‘ç«¯ï¼‰</option>
                                    <option value="bidirectional" selected>åŒå‘åŒæ­¥</option>
                                </select>
                            </div>
                            <div class="col-12 mt-4">
                                <div class="card border-primary mb-3">
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="wizardAutoSync" checked>
                                            <label class="form-check-label fw-bold" for="wizardAutoSync">å¯ç”¨è‡ªåŠ¨åŒæ­¥</label>
                                        </div>
                                        <p class="text-muted small mb-0 mt-1">å¼€å¯åï¼Œæ¯æ¬¡â€œç™»å½•æ¸¸æˆâ€æˆåŠŸæ—¶è‡ªåŠ¨ä¸Šä¼ ï¼Œå¯åŠ¨å·¥å…·æ—¶è‡ªåŠ¨å°è¯•ä¸‹è½½æ›´æ–°ã€‚</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Confirm -->
                    <div class="wizard-step" id="wizardStep4" style="display:none;">
                        <div class="text-center mb-4">
                            <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                            <h3 class="mt-3">å‡†å¤‡å°±ç»ª</h3>
                        </div>
                        <div class="alert alert-warning">
                            <h6 class="alert-heading"><i class="bi bi-exclamation-circle me-1"></i>æœ€åç¡®è®¤</h6>
                            <ul class="mb-0 small">
                                <li>è¯·ç¡®è®¤æ‚¨å·²ç»ä¿å­˜å¥½äº†ä¸»å¯†é’¥ã€‚å¦‚æœä¸¢å¤±ï¼Œæ²¡äººèƒ½å¸®æ‚¨æ‰¾å›æ•°æ®ã€‚</li>
                                <li>é…ç½®å®Œæˆåï¼Œæ‚¨å¯ä»¥éšæ—¶åœ¨ä¸»ç•Œé¢è°ƒæ•´è¿™äº›è®¾ç½®ã€‚</li>
                            </ul>
                        </div>
                        <div class="form-check mb-3 d-flex justify-content-center">
                            <div>
                                <input class="form-check-input" type="checkbox" id="wizardRunNow" checked>
                                <label class="form-check-label" for="wizardRunNow">å®Œæˆåç«‹å³æ‰§è¡Œä¸€æ¬¡åŒæ­¥</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" id="btnWizardPrev" onclick="wizardMove(-1)" disabled>ä¸Šä¸€æ­¥</button>
                    <button type="button" class="btn btn-primary px-4" id="btnWizardNext" onclick="wizardMove(1)">ä¸‹ä¸€æ­¥</button>
                    <button type="button" class="btn btn-success px-4" id="btnWizardFinish" onclick="wizardFinish()" style="display:none;">å®Œæˆå¹¶ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let wizardCurrentStep = 1;
        let wizardDownloadToken = null;
        let wizardRemoteProbe = null;

        function showCloudSyncWizard() {
            const modalEl = document.getElementById('cloudSyncWizardModal');
            if (!modalEl) {
                swal('é”™è¯¯', 'æœªæ‰¾åˆ°äº‘åŒæ­¥å‘å¯¼çª—å£ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
                return;
            }
            const modal = new bootstrap.Modal(modalEl);
            wizardCurrentStep = 1;
            wizardDownloadToken = null;
            wizardRemoteProbe = null;
            document.getElementById('wizardMode').value = 'import_existing';
            document.getElementById('wizardKeyInput').value = '';
            document.getElementById('wizardKeyFileInput').value = '';
            document.getElementById('wizardKeyDisplayArea').style.display = 'none';
            document.getElementById('wizardKeyText').innerText = '';
            document.getElementById('wizardProbeResult').style.display = 'none';
            document.getElementById('wizardProbeResult').innerText = '';
            document.getElementById('wizardPolicyAck').checked = false;
            document.getElementById('wizardRunNow').checked = true;
            wizardOnModeChange();
            _updateWizardUI();
            modal.show();
        }

        function wizardOnModeChange() {
            const mode = document.getElementById('wizardMode').value;
            const generateCard = document.getElementById('wizardGenerateCard');
            const keyDisplayArea = document.getElementById('wizardKeyDisplayArea');
            if (mode === 'import_existing') {
                if (generateCard) generateCard.style.display = 'none';
                if (keyDisplayArea) keyDisplayArea.style.display = 'none';
            } else {
                if (generateCard) generateCard.style.display = '';
            }
        }

        function wizardImportKeyFile(event) {
            const file = event && event.target && event.target.files ? event.target.files[0] : null;
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function (loadEvent) {
                const raw = String((loadEvent && loadEvent.target && loadEvent.target.result) || '');
                const match = raw.match(/master_key\s*=\s*([^\r\n]+)/i);
                let parsedKey = '';
                if (match && match[1]) {
                    parsedKey = match[1].trim();
                } else {
                    parsedKey = raw.trim();
                }
                if (!parsedKey) {
                    swal('å¯¼å…¥å¤±è´¥', 'æœªåœ¨æ–‡æœ¬ä¸­è§£æåˆ°ä¸»å¯†é’¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹', 'error');
                    return;
                }
                document.getElementById('wizardKeyInput').value = parsedKey;
                const valid = validateWizardKey();
                if (valid) {
                    swal('å¯¼å…¥æˆåŠŸ', 'å·²ä»æ–‡ä»¶ä¸­è¯»å–ä¸»å¯†é’¥', 'success');
                } else {
                    swal('å·²å¯¼å…¥', 'å·²è¯»å–åˆ°ä¸»å¯†é’¥ï¼Œä½†å¼ºåº¦ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ˜¯å¦æ­£ç¡®', 'warning');
                }
            };
            reader.onerror = function () {
                swal('å¯¼å…¥å¤±è´¥', 'è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            };
            reader.readAsText(file, 'utf-8');
        }

        function _updateWizardUI() {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`wizardStep${i}`);
                if (stepEl) {
                    stepEl.style.display = 'none';
                }
            }
            // Show current
            const currentStepEl = document.getElementById(`wizardStep${wizardCurrentStep}`);
            if (currentStepEl) {
                currentStepEl.style.display = 'block';
            }
            
            // Update Progress
            const progressEl = document.getElementById('wizardProgressBar');
            if (progressEl) {
                progressEl.style.width = `${wizardCurrentStep * 25}%`;
            }

            // Update Buttons
            document.getElementById('btnWizardPrev').disabled = (wizardCurrentStep === 1);
            
            if (wizardCurrentStep === 4) {
                document.getElementById('btnWizardNext').style.display = 'none';
                document.getElementById('btnWizardFinish').style.display = 'inline-block';
            } else {
                document.getElementById('btnWizardNext').style.display = 'inline-block';
                document.getElementById('btnWizardFinish').style.display = 'none';
            }
        }

        function validateWizardKey() {
            const key = document.getElementById('wizardKeyInput').value;
            const info = _evaluateMasterKeyStrength(key);
            const fb = document.getElementById('wizardKeyFeedback');
            if (!key) {
                fb.innerText = '';
                fb.className = 'form-text';
                return false;
            }
            if (info.valid) {
                fb.innerText = 'å¯†é’¥å¼ºåº¦åˆæ ¼';
                fb.className = 'form-text text-success';
                return true;
            } else {
                fb.innerText = 'å¯†é’¥å¼ºåº¦ä¸è¶³ (éœ€12ä½ä»¥ä¸Šä¸”å«3ç±»å­—ç¬¦)';
                fb.className = 'form-text text-danger';
                return false;
            }
        }

        function wizardGenKey() {
             fetch('/_idv-login/cloud-sync/generate-master-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ length: 16 }),
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const key = data.master_key;
                    document.getElementById('wizardKeyInput').value = key;
                    document.getElementById('wizardKeyText').innerText = key;
                    document.getElementById('wizardKeyDisplayArea').style.display = 'block';
                    wizardDownloadToken = null;
                    validateWizardKey();
                }
            });
        }

        function wizardTriggerTxtDownload() {
            const key = document.getElementById('wizardKeyInput').value;
            _downloadCloudSyncMasterKeyTxt(key);
        }    

        function copyWizardKey() {
            const text = document.getElementById('wizardKeyText').innerText;
            if(!text) return;
            navigator.clipboard.writeText(text).then(() => {
                swal('å·²å¤åˆ¶', 'å¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        function wizardMove(delta) {
            if (delta > 0) {
                // Validation before moving next
                if (wizardCurrentStep === 1) {
                    const policyAck = document.getElementById('wizardPolicyAck');
                    if (!policyAck || !policyAck.checked) {
                        swal('æç¤º', 'è¯·ä»”ç»†é˜…è¯»è¯¦ç»†è¯´æ˜å’Œéšç§æ”¿ç­–ï¼Œå¦‚æœæ‚¨ä¸åŒæ„ï¼Œæˆ‘ä»¬æ— æ³•ä¸ºæ‚¨æä¾›æœåŠ¡ã€‚', 'warning');
                        return;
                    }
                    _setCloudSyncPolicyAcked(true);
                    const mode = document.getElementById('wizardMode').value;
                    document.getElementById('wizardDirection').value = mode === 'import_existing' ? 'pull' : 'bidirectional';
                }
                if (wizardCurrentStep === 2) {
                    const isValid = validateWizardKey();
                    if (!isValid) {
                        swal('å¯†é’¥æ— æ•ˆ', 'è¯·è¾“å…¥æˆ–ç”Ÿæˆä¸€ä¸ªç¬¦åˆå¼ºåº¦è¦æ±‚çš„ä¸»å¯†é’¥', 'warning');
                        return;
                    }
                    const mode = document.getElementById('wizardMode').value;
                    if (mode === 'import_existing') {
                        const key = document.getElementById('wizardKeyInput').value;
                        const probeEl = document.getElementById('wizardProbeResult');
                        probeEl.style.display = 'block';
                        probeEl.className = 'alert alert-secondary py-2';
                        probeEl.innerText = 'æ­£åœ¨æ¢æµ‹äº‘ç«¯å·²æœ‰åŒæ­¥ï¼Œè¯·ç¨å€™...';
                        fetch('/_idv-login/cloud-sync/probe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ master_key: key }),
                        })
                            .then(r => r.json())
                            .then(data => {
                                if (!data.success) {
                                    probeEl.className = 'alert alert-danger py-2';
                                    probeEl.innerText = `æ¢æµ‹å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                                    throw new Error(data.error || 'probe_failed');
                                }
                                wizardRemoteProbe = data;
                                if (data.exists) {
                                    probeEl.className = 'alert alert-success py-2';
                                    probeEl.innerText = `å·²æ‰¾åˆ°äº‘ç«¯åŒæ­¥è®°å½•ï¼Œäº‘ç«¯è´¦å·çº¦ ${data.remote_channels_count || 0} ä¸ªã€‚å»ºè®®å…ˆæ‰§è¡Œâ€œå•å‘ä¸‹è½½ï¼ˆäº‘ç«¯â†’æœ¬åœ°ï¼‰â€ã€‚`;
                                    if ((data.remote_channels_count || 0) > 0) {
                                        document.getElementById('wizardDirection').value = 'pull';
                                    }
                                    wizardCurrentStep += delta;
                                    if (wizardCurrentStep < 1) wizardCurrentStep = 1;
                                    if (wizardCurrentStep > 4) wizardCurrentStep = 4;
                                    _updateWizardUI();
                                } else {
                                    probeEl.className = 'alert alert-warning py-2';
                                    probeEl.innerText = (data.message || 'æœªå‘ç°äº‘ç«¯åŒæ­¥è®°å½•') + 'ã€‚å½“å‰æ˜¯â€œå¯¼å…¥å·²æœ‰åŒæ­¥â€ï¼Œè¯·æ”¹é€‰â€œæˆ‘è¿˜æœªè®¾ç½®è¿‡åŒæ­¥â€åç»§ç»­ã€‚';
                                    document.getElementById('wizardDirection').value = 'push';
                                    swal('æœªæ‰¾åˆ°å·²æœ‰åŒæ­¥', 'äº‘ç«¯ä¸å­˜åœ¨è¯¥ä¸»å¯†é’¥å¯¹åº”çš„åŒæ­¥è®°å½•ã€‚è¯·åˆ‡æ¢åˆ°â€œæˆ‘è¿˜æœªè®¾ç½®è¿‡åŒæ­¥â€ç»§ç»­ã€‚', 'warning');
                                }
                            })
                            .catch(() => {
                                probeEl.className = 'alert alert-danger py-2';
                                if (!probeEl.innerText) {
                                    probeEl.innerText = 'æ¢æµ‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                                }
                            });
                        return;
                    }
                }
            }
            wizardCurrentStep += delta;
            if (wizardCurrentStep < 1) wizardCurrentStep = 1;
            if (wizardCurrentStep > 4) wizardCurrentStep = 4;
            _updateWizardUI();
        }

        function wizardFinish() {
            if (!_ensureCloudSyncPolicyAcked()) {
                return;
            }

            // Fill main form
            document.getElementById('cloudSyncMasterKey').value = document.getElementById('wizardKeyInput').value;
            // set remember level to master_key if user selected it
            document.getElementById('cloudSyncRememberLevel').value = document.getElementById('wizardRemember').value;
            document.getElementById('cloudSyncScopeType').value = document.getElementById('wizardScope').value;
            document.getElementById('cloudSyncDirection').value = document.getElementById('wizardDirection').value;
            
            const expireSec = document.getElementById('wizardExpire').value;
            _setCloudSyncExpireAtFromSeconds(expireSec);

            document.getElementById('cloudSyncAutoSync').checked = document.getElementById('wizardAutoSync').checked;
            const runNow = document.getElementById('wizardRunNow').checked;

            // Trigger Save
            saveCloudSyncSettings({
                onSuccess: () => {
                    if (runNow) {
                        runCloudSync('sync');
                    }
                }
            });
            
            // Hide Modal
            const modalEl = document.getElementById('cloudSyncWizardModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // Optional: Trigger Strength Update on main UI
            updateCloudSyncMasterKeyStrength();
        }
    </script>
</body>

</html>
